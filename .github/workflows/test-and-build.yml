name: ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶ - æµ‹è¯•ä¸æ„å»º

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©UTC 2:00è¿è¡Œ (åŒ—äº¬æ—¶é—´10:00)
    - cron: '0 2 * * *'

env:
  DOTNET_VERSION: '6.0.x'
  DOTNET_FRAMEWORK_VERSION: 'net48'
  PROJECT_NAME: 'ZWDynLookup'
  SOLUTION_NAME: 'ZWDynLookup.sln'
  TEST_PROJECT_NAME: 'ZWDynLookup.Tests'
  COVERAGE_THRESHOLD: 85

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: è¿˜åŸNuGetåŒ…
      run: |
        dotnet restore ${{ env.SOLUTION_NAME }}
        dotnet restore ${{ env.TEST_PROJECT_NAME }}/${{ env.TEST_PROJECT_NAME }}.csproj

    - name: å®‰è£…SonarScanner
      run: dotnet tool install --global dotnet-sonarscanner

    - name: SonarCloudåˆ†æ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        dotnet sonarscanner begin /k:"${{ env.PROJECT_NAME }}" /o:"zhongwang-cad" /d:sonar.login=${{ secrets.SONAR_TOKEN }} /d:sonar.host.url="https://sonarcloud.io"
        dotnet build ${{ env.SOLUTION_NAME }} --no-restore
        dotnet test ${{ env.TEST_PROJECT_NAME }}/${{ env.TEST_PROJECT_NAME }}.csproj --no-build --verbosity normal /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura /p:CoverletOutput=./coverage/
        dotnet sonarscanner end /d:sonar.login=${{ secrets.SONAR_TOKEN }}

    - name: ä¸Šä¼ SonarCloudåˆ†æç»“æœ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: .github/workflows/sonarcloud.sarif

  # Windowsç¯å¢ƒæµ‹è¯•
  test-windows:
    name: Windowsç¯å¢ƒæµ‹è¯•
    runs-on: windows-latest
    needs: code-quality
    
    strategy:
      matrix:
        configuration: [Debug, Release]
        framework: [net48]
        
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® .NET Framework
      uses: microsoft/setup-msbuild@v1.1
      with:
        msbuild-version: '17.6'

    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: å®‰è£…MSBuild
      run: |
        choco install msbuild --version 17.6.0

    - name: è¿˜åŸNuGetåŒ…
      shell: pwsh
      run: |
        dotnet restore ${{ env.SOLUTION_NAME }}
        dotnet restore ${{ env.TEST_PROJECT_NAME }}/${{ env.TEST_PROJECT_NAME }}.csproj

    - name: ç¼“å­˜NuGetåŒ…
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    # æ„å»ºé¡¹ç›®
    - name: æ„å»ºé¡¹ç›® (${{ matrix.configuration }})
      shell: pwsh
      run: |
        Write-Host "æ„å»ºé¡¹ç›® - ${{ matrix.configuration }} æ¨¡å¼" -ForegroundColor Green
        msbuild ${{ env.SOLUTION_NAME }} /p:Configuration=${{ matrix.configuration }} /p:Platform="Any CPU" /p:RestorePackages=true /v:minimal
        
        # éªŒè¯æ„å»ºè¾“å‡º
        if (Test-Path "bin\${{ matrix.configuration }}\net48\ZWDynLookup.dll") {
          Write-Host "ä¸»é¡¹ç›®æ„å»ºæˆåŠŸ" -ForegroundColor Green
        } else {
          Write-Host "ä¸»é¡¹ç›®æ„å»ºå¤±è´¥" -ForegroundColor Red
          exit 1
        }

    # è¿è¡Œå•å…ƒæµ‹è¯•
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      shell: pwsh
      run: |
        Write-Host "å¼€å§‹å•å…ƒæµ‹è¯•..." -ForegroundColor Green
        
        # è¿è¡Œæ‰€æœ‰æµ‹è¯•
        dotnet test ${{ env.TEST_PROJECT_NAME }}/${{ env.TEST_PROJECT_NAME }}.csproj `
          --configuration ${{ matrix.configuration }} `
          --framework ${{ env.DOTNET_FRAMEWORK_VERSION }} `
          --no-build `
          --verbosity normal `
          --logger trx `
          --collect:"XPlat Code Coverage" `
          --DataCollectionRunSettings.Configuration.DataCollectionAgents.DataCollector.Configuration.Format=cobertura

    # ä»£ç è¦†ç›–ç‡åˆ†æ
    - name: ä»£ç è¦†ç›–ç‡åˆ†æ
      shell: pwsh
      run: |
        Write-Host "åˆ†æä»£ç è¦†ç›–ç‡..." -ForegroundColor Green
        
        # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        $coverageFiles = Get-ChildItem -Path "TestResults" -Filter "*.cobertura.xml" -Recurse
        if ($coverageFiles) {
          Write-Host "æ‰¾åˆ°è¦†ç›–ç‡æ–‡ä»¶: $($coverageFiles.Count)" -ForegroundColor Yellow
          foreach ($file in $coverageFiles) {
            Write-Host "å¤„ç†æ–‡ä»¶: $($file.FullName)" -ForegroundColor Cyan
          }
        } else {
          Write-Host "è­¦å‘Š: æœªæ‰¾åˆ°è¦†ç›–ç‡æ–‡ä»¶" -ForegroundColor Yellow
        }

    # é›†æˆæµ‹è¯•
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      shell: pwsh
      run: |
        Write-Host "å¼€å§‹é›†æˆæµ‹è¯•..." -ForegroundColor Green
        
        # æ¨¡æ‹Ÿä¸­æœ›CADç¯å¢ƒè¿›è¡Œé›†æˆæµ‹è¯•
        $env:ZHONGCAD_SIMULATION = "true"
        $env:INTEGRATION_TEST_MODE = "true"
        $env:ZWCAD_API_MODE = "true"
        
        dotnet test ${{ env.TEST_PROJECT_NAME }}/${{ env.TEST_PROJECT_NAME }}.csproj `
          --configuration ${{ matrix.configuration }} `
          --framework ${{ env.DOTNET_FRAMEWORK_VERSION }} `
          --no-build `
          --verbosity detailed `
          --filter "Category=Integration" `
          --logger trx

    # æ€§èƒ½æµ‹è¯•
    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      shell: pwsh
      continue-on-error: true
      run: |
        Write-Host "å¼€å§‹æ€§èƒ½æµ‹è¯•..." -ForegroundColor Green
        
        # è®¾ç½®æ€§èƒ½æµ‹è¯•ç¯å¢ƒ
        $env:PERFORMANCE_TEST_MODE = "true"
        $env:BENCHMARK_CONFIG_PATH = "${{ env.TEST_PROJECT_NAME }}/Performance/BenchmarkConfig.json"
        
        dotnet test ${{ env.TEST_PROJECT_NAME }}/${{ env.TEST_PROJECT_NAME }}.csproj `
          --configuration ${{ matrix.configuration }} `
          --framework ${{ env.DOTNET_FRAMEWORK_VERSION }} `
          --no-build `
          --verbosity normal `
          --filter "Category=Performance" `
          --logger trx

    # æ€§èƒ½å’Œè¦†ç›–ç‡æŠ¥å‘Š
    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-windows-${{ matrix.configuration }}
        path: |
          TestResults/*.trx
          TestResults/*.coverage
          TestResults/*.cobertura.xml
        retention-days: 30

    - name: å‘å¸ƒæµ‹è¯•ç»“æœ
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: æµ‹è¯•æŠ¥å‘Š - Windows ${{ matrix.configuration }}
        path: TestResults/*.trx
        reporter: dotnet-trx

  # UIæµ‹è¯• (éœ€è¦ä¸­æœ›CADç¯å¢ƒ)
  test-ui:
    name: UIè‡ªåŠ¨åŒ–æµ‹è¯•
    runs-on: windows-latest
    needs: test-windows
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: å®‰è£…ä¸­æœ›CADä¾èµ–
      run: |
        # æ¨¡æ‹Ÿä¸­æœ›CADç¯å¢ƒå˜é‡
        echo "ZHONGCAD_VERSION=2024" >> $env:GITHUB_ENV
        echo "ZHONGCAD_PATH=C:\Program Files\ZWSOFT\ZWCAD 2024" >> $env:GITHUB_ENV
        echo "ZWCAD_API_MODE=true" >> $env:GITHUB_ENV
        
    - name: è¿˜åŸNuGetåŒ…
      shell: pwsh
      run: |
        dotnet restore ${{ env.SOLUTION_NAME }}
        dotnet restore ${{ env.TEST_PROJECT_NAME }}/${{ env.TEST_PROJECT_NAME }}.csproj

    - name: æ„å»ºé¡¹ç›®
      shell: pwsh
      run: |
        msbuild ${{ env.SOLUTION_NAME }} /p:Configuration=Release /p:Platform="Any CPU" /v:minimal

    - name: è¿è¡ŒUIæµ‹è¯• (æ¨¡æ‹Ÿæ¨¡å¼)
      shell: pwsh
      continue-on-error: true
      env:
        UI_TEST_MODE: "simulation"
        ZWCAD_AUTOMATION: "true"
      run: |
        Write-Host "å¼€å§‹UIè‡ªåŠ¨åŒ–æµ‹è¯•..." -ForegroundColor Green
        
        # è®¾ç½®ä¸­æœ›CAD UIæµ‹è¯•ç¯å¢ƒå˜é‡
        $env:UI_TEST_MODE = "simulation"
        $env:ZWCAD_AUTOMATION = "true"
        $env:HEADLESS_MODE = "true"
        $env:ZHONGCAD_API_MODE = "true"
        
        dotnet test ${{ env.TEST_PROJECT_NAME }}/${{ env.TEST_PROJECT_NAME }}.csproj `
          --configuration Release `
          --framework ${{ env.DOTNET_FRAMEWORK_VERSION }} `
          --no-build `
          --verbosity normal `
          --filter "Category=UI" `
          --logger trx

    - name: ä¸Šä¼ UIæµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ui-test-results
        path: |
          TestResults/*.trx
          UI/TestScreenshots/
        retention-days: 30

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: è¿è¡Œå®‰å…¨æ‰«æ
      run: |
        dotnet restore ${{ env.SOLUTION_NAME }}
        dotnet list package --vulnerable --deprecated --outdated

    - name: è¿è¡ŒCodeQLåˆ†æ
      uses: github/codeql-action/init@v2
      with:
        languages: csharp

    - name: è‡ªä¸»æ„å»º
      run: |
        dotnet build ${{ env.SOLUTION_NAME }} --no-restore

    - name: æ‰§è¡ŒCodeQLåˆ†æ
      uses: github/codeql-action/analyze@v2

  # è®¸å¯è¯æ£€æŸ¥
  license-check:
    name: è®¸å¯è¯æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: è®¸å¯è¯æ‰«æ
      run: |
        dotnet restore ${{ env.SOLUTION_NAME }}
        
        # æ£€æŸ¥ç¬¬ä¸‰æ–¹åº“è®¸å¯è¯
        dotnet list package --include-transitive | tee licenses.txt
        
        echo "è®¸å¯è¯æ‰«æå®Œæˆ" >> $GITHUB_STEP_SUMMARY

  # å‘å¸ƒå‡†å¤‡
  prepare-release:
    name: å‘å¸ƒå‡†å¤‡
    runs-on: ubuntu-latest
    needs: [test-windows, test-ui, security-scan, license-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ç”Ÿæˆç‰ˆæœ¬å·
      id: version
      run: |
        $version = "v1.0.0-${{ github.run_number }}"
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "Generated version: $version"

    - name: æ„å»ºå‘å¸ƒç‰ˆæœ¬
      run: |
        dotnet restore ${{ env.SOLUTION_NAME }}
        dotnet build ${{ env.SOLUTION_NAME }} --configuration Release --no-restore

    - name: è¿è¡Œå‘å¸ƒæµ‹è¯•
      run: |
        dotnet test ${{ env.TEST_PROJECT_NAME }}/${{ env.TEST_PROJECT_NAME }}.csproj --configuration Release --no-build --filter "Category=UnitTest"

    - name: æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      run: |
        New-Item -ItemType Directory -Path release -Force
        
        # å¤åˆ¶æ„å»ºè¾“å‡º
        Copy-Item -Path "bin\Release\net48\ZWDynLookup.dll" -Destination "release\" -Force
        Copy-Item -Path "bin\Release\net48\ZWDynLookup.pdb" -Destination "release\" -Force
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        Copy-Item -Path "ZWDynLookup.sln" -Destination "release\" -Force
        Copy-Item -Path "docs\*.md" -Destination "release\docs\" -Recurse -Force
        
        # å¤åˆ¶æµ‹è¯•æŠ¥å‘Š
        Copy-Item -Path "TestResults" -Destination "release\test-results" -Recurse -Force
        
        # æ‰“åŒ…
        Compress-Archive -Path "release\*" -DestinationPath "ZWDynLookup-${{ steps.version.outputs.version }}.zip"

    - name: ä¸Šä¼ å‘å¸ƒåŒ…
      uses: actions/upload-artifact@v3
      with:
        name: release-package-${{ steps.version.outputs.version }}
        path: ZWDynLookup-${{ steps.version.outputs.version }}.zip
        retention-days: 90

    - name: åˆ›å»ºGitHubå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        body: |
          ## ğŸ¯ ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶ v${{ steps.version.outputs.version }}
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          - âœ… å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–
          - âœ… é›†æˆæµ‹è¯•éªŒè¯
          - âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•
          - âœ… UIè‡ªåŠ¨åŒ–æµ‹è¯•
          - âœ… å®‰å…¨æ‰«æé€šè¿‡
          - âœ… è®¸å¯è¯æ£€æŸ¥å®Œæˆ
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          - ZWDynLookup.dll - æ’ä»¶ä¸»ç¨‹åº
          - ZWDynLookup.pdb - è°ƒè¯•ç¬¦å·æ–‡ä»¶
          - docs/ - å®Œæ•´æ–‡æ¡£
          - test-results/ - æµ‹è¯•æŠ¥å‘Š
          
          ### ğŸ”§ å®‰è£…è¯´æ˜
          1. å°† ZWDynLookup.dll å¤åˆ¶åˆ°ä¸­æœ›CADæ’ä»¶ç›®å½•
          2. åœ¨ä¸­æœ›CADä¸­åŠ è½½æ’ä»¶
          3. ä½¿ç”¨ BPARAMETER K å’Œ BACTIONTOOL L å‘½ä»¤
          
          ### ğŸ“ æŠ€æœ¯æ”¯æŒ
          å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹ docs/ ç›®å½•ä¸‹çš„æ–‡æ¡£ã€‚
        files: |
          ZWDynLookup-${{ steps.version.outputs.version }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # é€šçŸ¥å’ŒæŠ¥å‘Š
  notify-results:
    name: é€šçŸ¥æµ‹è¯•ç»“æœ
    runs-on: ubuntu-latest
    needs: [test-windows, test-ui, security-scan, license-check]
    if: always()
    
    steps:
    - name: è·å–æµ‹è¯•ç»“æœ
      uses: actions/download-artifact@v3
      
    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ‘˜è¦
      run: |
        echo "## ğŸ“Š ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶ - æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ·ï¸ æµ‹è¯•ç¯å¢ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æ“ä½œç³»ç»Ÿ**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- **.NETç‰ˆæœ¬**: ${{ env.DOTNET_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¡†æ¶ç‰ˆæœ¬**: ${{ env.DOTNET_FRAMEWORK_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âœ… æµ‹è¯•ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "| æµ‹è¯•ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ä»£ç è´¨é‡æ£€æŸ¥ | ${{ needs.code-quality.result }} | SonarCloudåˆ†æ |" >> $GITHUB_STEP_SUMMARY
        echo "| Windowsç¯å¢ƒæµ‹è¯• | ${{ needs.test-windows.result }} | å•å…ƒ/é›†æˆ/æ€§èƒ½æµ‹è¯• |" >> $GITHUB_STEP_SUMMARY
        echo "| UIè‡ªåŠ¨åŒ–æµ‹è¯• | ${{ needs.test-ui.result }} | ç”¨æˆ·ç•Œé¢æµ‹è¯• |" >> $GITHUB_STEP_SUMMARY
        echo "| å®‰å…¨æ‰«æ | ${{ needs.security-scan.result }} | æ¼æ´å’Œä¾èµ–æ£€æŸ¥ |" >> $GITHUB_STEP_SUMMARY
        echo "| è®¸å¯è¯æ£€æŸ¥ | ${{ needs.license-check.result }} | ç¬¬ä¸‰æ–¹åº“è®¸å¯è¯ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ€»ä½“çŠ¶æ€
        if [[ "${{ needs.code-quality.result }}" == "success" && "${{ needs.test-windows.result }}" == "success" && "${{ needs.security-scan.result }}" == "success" ]]; then
          echo "### ğŸ‰ æµ‹è¯•ç»“æœ: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰æ ¸å¿ƒæµ‹è¯•å‡å·²é€šè¿‡ï¼Œä»£ç è´¨é‡è‰¯å¥½ï¼" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ æµ‹è¯•ç»“æœ: âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "éƒ¨åˆ†æµ‹è¯•æœªé€šè¿‡ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯å¹¶ä¿®å¤é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
        fi

    - name: å‘é€é€šçŸ¥
      if: always()
      run: |
        if [[ "${{ needs.code-quality.result }}" == "success" && "${{ needs.test-windows.result }}" == "success" && "${{ needs.security-scan.result }}" == "success" ]]; then
          echo "ğŸ‰ æµ‹è¯•é€šè¿‡ï¼"
          echo "æ‰€æœ‰æµ‹è¯•ä»»åŠ¡å‡å·²æˆåŠŸå®Œæˆã€‚"
        else
          echo "âš ï¸ æµ‹è¯•å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥å¤±è´¥çš„æµ‹è¯•ä»»åŠ¡å¹¶ä¿®å¤ç›¸å…³é—®é¢˜ã€‚"
        fi