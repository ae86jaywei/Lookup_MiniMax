---
AIGC:
    ContentProducer: Minimax Agent AI
    ContentPropagator: Minimax Agent AI
    Label: AIGC
    ProduceID: "00000000000000000000000000000000"
    PropagateID: "00000000000000000000000000000000"
    ReservedCode1: 304402200ada63a2cd48eab6f4d0cf2f7fab6a7b9273338d803c0d6b2f12e6158e91ca990220609b1cf7029ac54adca62b34a173f5e79e4e71ead3a8c8039c451abad7068c76
    ReservedCode2: 3045022100b8f38611b65a4c6a2e5f2101b1cfe32218b1ffe577a4d979fb4b863bffaabb050220397e48aa52e8fdb7f067674206797e0a5449d40ce7b1dc14161b4ee4c92a48df
---

# 测试环境配置指南

## 概述

完善的测试环境配置是确保测试可靠性和可重复性的基础。本指南详细说明了ZWDynLookup项目测试环境的搭建、配置和维护流程。

## 环境架构概述

```
┌─────────────────────────────────────────────────────────────┐
│                    测试执行环境                              │
├─────────────────────────────────────────────────────────────┤
│  开发机器  │  CI/CD服务器  │  测试机器  │  性能测试机器       │
│  Visual   │  Azure DevOps │  AutoCAD   │  压力测试环境       │
│  Studio   │  GitHub Actions│  安装      │  负载生成器         │
├─────────────────────────────────────────────────────────────┤
│                    共享服务层                                │
├─────────────────────────────────────────────────────────────┤
│  数据库   │  文件存储    │  消息队列  │  监控服务           │
│  测试数据 │  测试报告    │  日志聚合  │  性能监控           │
└─────────────────────────────────────────────────────────────┘
```

## 本地开发环境配置

### 1. 开发机器要求

#### 硬件配置
```yaml
最低配置:
  CPU: Intel i5-8400 或 AMD Ryzen 5 2600
  内存: 16GB DDR4
  存储: 256GB SSD 可用空间
  显卡: 支持DirectX 11的独立显卡

推荐配置:
  CPU: Intel i7-10700K 或 AMD Ryzen 7 3700X
  内存: 32GB DDR4
  存储: 512GB NVMe SSD
  显卡: 专业级显卡
```

#### 软件环境
```yaml
操作系统:
  - Windows 10 Pro/Enterprise (64位)
  - Windows 11 Pro/Enterprise (64位)

开发工具:
  - Visual Studio 2022 Professional 或 Enterprise
  - .NET 8.0 SDK
  - Git for Windows
  - NuGet Package Manager

AutoCAD版本:
  - AutoCAD 2024 (主要测试版本)
  - AutoCAD 2023 (兼容性测试)
  - AutoCAD 2025 (前沿测试)
```

### 2. Visual Studio项目配置

#### 测试项目结构
```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net8.0-windows</TargetFramework>
    <UseWPF>true</UseWPF>
    <UseWindowsForms>true</UseWindowsForms>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <IsPackable>false</IsPackable>
    <IsTestProject>true</IsTestProject>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.8.0" />
    <PackageReference Include="MSTest.TestAdapter" Version="3.1.1" />
    <PackageReference Include="MSTest.TestFramework" Version="3.1.1" />
    <PackageReference Include="coverlet.collector" Version="6.0.0">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Moq" Version="4.20.69" />
    <PackageReference Include="White" Version="0.13.0" />
    <PackageReference Include="Microsoft.Extensions.Logging" Version="8.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\ZWDynLookup\ZWDynLookup.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Content Include="TestData\**\*">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>
</Project>
```

### 3. 测试配置文件

#### TestConfig.json
```json
{
  "testEnvironment": {
    "name": "LocalDevelopment",
    "version": "1.0",
    "autoCADVersion": "2024",
    "netVersion": "8.0"
  },
  "database": {
    "connectionString": "Server=(localdb)\\MSSQLLocalDB;Database=ZWDynLookup_Test;Integrated Security=true;",
    "timeout": 30,
    "retryCount": 3
  },
  "autoCAD": {
    "installationPath": "C:\\Program Files\\Autodesk\\AutoCAD 2024",
    "workingDirectory": "C:\\Temp\\ZWDynLookup_Tests",
    "launchTimeout": 30000,
    "commandTimeout": 10000
  },
  "performance": {
    "enableProfiling": false,
    "memoryThresholdMB": 200,
    "cpuThresholdPercent": 80,
    "responseTimeThresholdMs": 2000
  },
  "logging": {
    "level": "Debug",
    "filePath": "Logs/test-execution.log",
    "maxFileSizeMB": 10,
    "maxFiles": 5
  },
  "coverage": {
    "enabled": true,
    "threshold": 85,
    "outputFormat": "cobertura",
    "outputPath": "Coverage"
  }
}
```

#### TestData.json
```json
{
  "testDrawings": {
    "path": "TestData/Drawings",
    "files": [
      "SimpleDrawing.dwg",
      "ComplexDrawing.dwg",
      "LargeDrawing.dwg",
      "EmptyDrawing.dwg"
    ]
  },
  "sampleData": {
    "lookupTables": [
      {
        "name": "StandardTable",
        "parameters": ["Width", "Height", "Length"],
        "rows": 10
      },
      {
        "name": "LargeTable",
        "parameters": ["X", "Y", "Z", "Rotation"],
        "rows": 1000
      }
    ]
  },
  "performanceData": {
    "largeDataset": {
      "rows": 10000,
      "parameters": 50,
      "fileName": "PerformanceTest.dwg"
    },
    "stressTest": {
      "concurrentUsers": 20,
      "operationsPerUser": 100
    }
  }
}
```

## AutoCAD集成环境配置

### 1. AutoCAD安装和配置

#### 自动安装脚本
```powershell
# Install-AutoCAD.ps1
param(
    [Parameter(Mandatory=$true)]
    [string]$InstallerPath,
    
    [Parameter(Mandatory=$false)]
    [string]$InstallDir = "C:\Program Files\Autodesk",
    
    [Parameter(Mandatory=$false)]
    [switch]$Silent
)

Write-Host "开始安装 AutoCAD..." -ForegroundColor Green

$installerArgs = @()
if ($Silent) {
    $installerArgs += "/silent"
    $installerArgs += "/norestart"
}

$installerArgs += "/install"
$installerArgs += "/log"
$installerArgs += "C:\Temp\AutoCAD_Install.log"

try {
    Start-Process -FilePath $InstallerPath -ArgumentList $installerArgs -Wait -PassThru
    Write-Host "AutoCAD 安装完成" -ForegroundColor Green
    
    # 配置AutoCAD
    Configure-AutoCAD
}
catch {
    Write-Error "AutoCAD 安装失败: $($_.Exception.Message)"
    exit 1
}

function Configure-AutoCAD {
    Write-Host "配置 AutoCAD 环境..." -ForegroundColor Yellow
    
    # 设置工作目录
    $workDir = "C:\Temp\ZWDynLookup_Tests"
    if (!(Test-Path $workDir)) {
        New-Item -Path $workDir -ItemType Directory -Force
    }
    
    # 配置注册表
    $regPath = "HKLM:\SOFTWARE\Autodesk\AutoCAD\R24.0\ACAD-0001:409"
    Set-ItemProperty -Path $regPath -Name "Configuration" -Value $workDir
    
    Write-Host "AutoCAD 配置完成" -ForegroundColor Green
}
```

#### AutoCAD测试环境初始化
```csharp
public class AutoCADTestEnvironment : IDisposable
{
    private readonly string _installPath;
    private readonly string _workingDirectory;
    private readonly ILogger _logger;
    
    public AutoCADTestEnvironment(string installPath, string workingDirectory)
    {
        _installPath = installPath;
        _workingDirectory = workingDirectory;
        _logger = LoggerFactory.Create(builder => builder.AddConsole())
            .CreateLogger<AutoCADTestEnvironment>();
        
        InitializeEnvironment();
    }
    
    private void InitializeEnvironment()
    {
        // 创建工作目录
        Directory.CreateDirectory(_workingDirectory);
        
        // 准备测试数据库
        PrepareTestDatabases();
        
        // 配置AutoCAD环境变量
        ConfigureEnvironmentVariables();
        
        // 初始化插件加载环境
        InitializePluginEnvironment();
    }
    
    public async Task<Application> LaunchAutoCAD()
    {
        _logger.LogInformation("启动AutoCAD测试实例...");
        
        var processStartInfo = new ProcessStartInfo
        {
            FileName = Path.Combine(_installPath, "acad.exe"),
            Arguments = "/b /nologo /nosplash",
            UseShellExecute = false,
            CreateNoWindow = false,
            WorkingDirectory = _workingDirectory
        };
        
        var process = Process.Start(processStartInfo);
        if (process == null)
        {
            throw new InvalidOperationException("无法启动AutoCAD进程");
        }
        
        // 等待AutoCAD完全启动
        await WaitForAutoCADReady(process);
        
        // 获取AutoCAD COM对象
        var application = await GetAutoCADApplication();
        
        _logger.LogInformation("AutoCAD测试环境准备完成");
        return application;
    }
    
    private async Task WaitForAutoCADReady(Process process)
    {
        var timeout = TimeSpan.FromSeconds(30);
        var startTime = DateTime.Now;
        
        while (DateTime.Now - startTime < timeout)
        {
            try
            {
                // 检查AutoCAD是否响应
                var acadProcess = Process.GetProcessById(process.Id);
                if (acadProcess.Responding)
                {
                    // 进一步验证COM对象可访问性
                    await Task.Delay(2000);
                    return;
                }
            }
            catch
            {
                // 进程可能还未完全启动
                await Task.Delay(1000);
            }
        }
        
        throw new TimeoutException("AutoCAD启动超时");
    }
    
    private async Task<Application> GetAutoCADApplication()
    {
        var maxRetries = 10;
        var retryDelay = TimeSpan.FromSeconds(2);
        
        for (int i = 0; i < maxRetries; i++)
        {
            try
            {
                var application = (Application)Marshal.GetActiveObject("AutoCAD.Application");
                if (application != null)
                {
                    return application;
                }
            }
            catch (COMException)
            {
                // AutoCAD COM对象还未就绪
                await Task.Delay(retryDelay);
            }
        }
        
        throw new InvalidOperationException("无法获取AutoCAD COM对象");
    }
    
    public void Dispose()
    {
        _logger.LogInformation("清理AutoCAD测试环境...");
        
        // 关闭所有AutoCAD实例
        var acadProcesses = Process.GetProcessesByName("acad");
        foreach (var process in acadProcesses)
        {
            try
            {
                process.CloseMainWindow();
                process.WaitForExit(5000);
                
                if (!process.HasExited)
                {
                    process.Kill();
                }
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, "关闭AutoCAD进程失败");
            }
        }
        
        // 清理临时文件
        try
        {
            if (Directory.Exists(_workingDirectory))
            {
                Directory.Delete(_workingDirectory, true);
            }
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "清理工作目录失败");
        }
    }
}
```

### 2. 插件加载配置

#### AutoCAD启动脚本
```lisp
;; acaddoc.lsp - AutoCAD启动脚本
(defun StartZWDynLookupTests (/ acadDoc)
  (setq acadDoc (vla-get-activedocument (vlax-get-acad-object)))
  
  ;; 加载插件
  (vl-load-com)
  (princ "\n开始加载 ZWDynLookup 测试环境...")
  
  ;; 初始化测试环境
  (Initialize-Test-Environment)
  
  ;; 设置测试参数
  (Set-Test-Parameters)
  
  (princ "\nZWDynLookup 测试环境初始化完成")
  (princ)
)

(defun Initialize-Test-Environment ()
  (princ "\n初始化测试环境...")
  
  ;; 创建测试图层
  (Create-Test-Layers)
  
  ;; 初始化测试数据
  (Initialize-Test-Data)
  
  ;; 设置测试模式
  (Set-Test-Mode)
)

(defun Create-Test-Layers ()
  (setq testLayers '("LookupTest" "ParameterTest" "GraphicsTest"))
  
  (foreach layer testLayers
    (if (not (tblsearch "LAYER" layer))
      (progn
        (command "_LAYER" "_NEW" layer "")
        (princ (strcat "\n创建测试图层: " layer))
      )
    )
  )
)

(defun Initialize-Test-Data ()
  ;; 初始化测试用的查寻表数据
  (setq *testLookupTables* (list))
  (princ "\n测试数据初始化完成")
)

(defun Set-Test-Parameters ()
  ;; 设置测试相关系统变量
  (setvar "OSMODE" 0)        ; 关闭对象捕捉
  (setvar "CMDECHO" 0)       ; 关闭命令回显
  (setvar "HIGHLIGHT" 1)     ; 启用高亮显示
  (princ "\n测试参数设置完成")
)

;; 加载时自动执行
(StartZWDynLookupTests)
```

## 数据库测试环境

### 1. 测试数据库配置

#### SQL Server LocalDB配置
```sql
-- 创建测试数据库
IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = 'ZWDynLookup_Test')
BEGIN
    CREATE DATABASE ZWDynLookup_Test;
END
GO

USE ZWDynLookup_Test;
GO

-- 创建测试表结构
CREATE TABLE LookupTables (
    TableId UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    TableName NVARCHAR(255) NOT NULL,
    Description NVARCHAR(500),
    CreatedDate DATETIME2 NOT NULL DEFAULT GETDATE(),
    ModifiedDate DATETIME2 NOT NULL DEFAULT GETDATE(),
    IsActive BIT NOT NULL DEFAULT 1
);

CREATE TABLE Parameters (
    ParameterId UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    TableId UNIQUEIDENTIFIER NOT NULL,
    ParameterName NVARCHAR(100) NOT NULL,
    ParameterType NVARCHAR(50) NOT NULL,
    DefaultValue NVARCHAR(255),
    IsRequired BIT NOT NULL DEFAULT 0,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETDATE(),
    FOREIGN KEY (TableId) REFERENCES LookupTables(TableId)
);

CREATE TABLE LookupTableData (
    DataId UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    TableId UNIQUEIDENTIFIER NOT NULL,
    RowData NVARCHAR(MAX) NOT NULL, -- JSON格式存储行数据
    CreatedDate DATETIME2 NOT NULL DEFAULT GETDATE(),
    FOREIGN KEY (TableId) REFERENCES LookupTables(TableId)
);

-- 创建索引
CREATE INDEX IX_Parameters_TableId ON Parameters(TableId);
CREATE INDEX IX_LookupTableData_TableId ON LookupTableData(TableId);

-- 插入测试数据
INSERT INTO LookupTables (TableName, Description) VALUES 
('StandardParameters', '标准参数表'),
('CustomParameters', '自定义参数表'),
('PerformanceTest', '性能测试表');

-- 为每个表添加参数
DECLARE @TableId1 UNIQUEIDENTIFIER = (SELECT TableId FROM LookupTables WHERE TableName = 'StandardParameters');
DECLARE @TableId2 UNIQUEIDENTIFIER = (SELECT TableId FROM LookupTables WHERE TableName = 'CustomParameters');
DECLARE @TableId3 UNIQUEIDENTIFIER = (SELECT TableId FROM LookupTables WHERE TableName = 'PerformanceTest');

INSERT INTO Parameters (TableId, ParameterName, ParameterType, DefaultValue) VALUES 
(@TableId1, 'Width', 'Double', '100.0'),
(@TableId1, 'Height', 'Double', '50.0'),
(@TableId1, 'Length', 'Double', '200.0'),
(@TableId2, 'X', 'Double', '0.0'),
(@TableId2, 'Y', 'Double', '0.0'),
(@TableId2, 'Z', 'Double', '0.0'),
(@TableId2, 'Rotation', 'Double', '0.0');

-- 生成性能测试数据
DECLARE @i INT = 1;
DECLARE @RowCount INT = 1000;

WHILE @i <= @RowCount
BEGIN
    INSERT INTO LookupTableData (TableId, RowData) VALUES 
    (@TableId3, '{"Parameter1": "' + CAST(@i AS NVARCHAR(10)) + '", "Parameter2": "' + CAST(@i * 1.5 AS NVARCHAR(10)) + '", "Parameter3": "' + CAST(@i * 2.0 AS NVARCHAR(10)) + '"}');
    SET @i = @i + 1;
END
```

### 2. 数据库连接管理

```csharp
public class TestDatabaseManager : IDisposable
{
    private readonly string _connectionString;
    private readonly ILogger _logger;
    
    public TestDatabaseManager(string connectionString)
    {
        _connectionString = connectionString;
        _logger = LoggerFactory.Create(builder => builder.AddConsole())
            .CreateLogger<TestDatabaseManager>();
        
        EnsureDatabaseExists();
    }
    
    public void EnsureDatabaseExists()
    {
        using var connection = new SqlConnection(_connectionString);
        try
        {
            connection.Open();
            _logger.LogInformation("测试数据库连接成功");
        }
        catch (SqlException)
        {
            // 数据库可能不存在，尝试创建
            CreateDatabase();
        }
    }
    
    private void CreateDatabase()
    {
        _logger.LogInformation("创建测试数据库...");
        
        var masterConnectionString = _connectionString.Replace("Database=ZWDynLookup_Test;", "Database=master;");
        using var connection = new SqlConnection(masterConnectionString);
        
        connection.Open();
        
        var createDbCommand = new SqlCommand("CREATE DATABASE ZWDynLookup_Test", connection);
        createDbCommand.ExecuteNonQuery();
        
        _logger.LogInformation("测试数据库创建完成");
        
        // 运行数据库初始化脚本
        InitializeDatabase();
    }
    
    private void InitializeDatabase()
    {
        var scriptPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, 
            "Database", "InitializeTestDatabase.sql");
        
        if (File.Exists(scriptPath))
        {
            var script = File.ReadAllText(scriptPath);
            ExecuteScript(script);
        }
    }
    
    public void ExecuteScript(string script)
    {
        using var connection = new SqlConnection(_connectionString);
        connection.Open();
        
        var batches = script.Split(new[] { "GO\r\n", "GO\n", "GO;" }, 
            StringSplitOptions.RemoveEmptyEntries);
        
        foreach (var batch in batches)
        {
            if (!string.IsNullOrWhiteSpace(batch))
            {
                using var command = new SqlCommand(batch, connection);
                command.ExecuteNonQuery();
            }
        }
        
        _logger.LogInformation($"执行SQL脚本完成，共 {batches.Length} 个批次");
    }
    
    public void CleanTestData()
    {
        using var connection = new SqlConnection(_connectionString);
        connection.Open();
        
        var cleanCommands = new[]
        {
            "DELETE FROM LookupTableData",
            "DELETE FROM Parameters", 
            "DELETE FROM LookupTables"
        };
        
        foreach (var commandText in cleanCommands)
        {
            using var command = new SqlCommand(commandText, connection);
            command.ExecuteNonQuery();
        }
        
        _logger.LogInformation("测试数据清理完成");
    }
    
    public void Dispose()
    {
        // 数据库连接清理逻辑
    }
}
```

## CI/CD测试环境

### 1. Azure DevOps配置

#### azure-pipelines.yml
```yaml
trigger:
- main
- develop

pool:
  vmImage: 'windows-latest'

variables:
  solution: '**/*.sln'
  buildPlatform: 'x64'
  buildConfiguration: 'Release'
  dotNetFramework: 'net8.0-windows'
  
stages:
- stage: Build
  jobs:
  - job: Build
    steps:
    - task: UseDotNet@2
      displayName: '使用 .NET 8.0'
      inputs:
        packageType: 'sdk'
        version: '8.0.x'
        
    - task: DotNetCoreCLI@2
      displayName: '还原 NuGet 包'
      inputs:
        command: 'restore'
        projects: '$(solution)'
        
    - task: DotNetCoreCLI@2
      displayName: '构建解决方案'
      inputs:
        command: 'build'
        projects: '$(solution)'
        arguments: '--configuration $(buildConfiguration) --no-restore'
        
    - task: DotNetCoreCLI@2
      displayName: '运行单元测试'
      inputs:
        command: 'test'
        projects: 'ZWDynLookup.Tests/ZWDynLookup.Tests.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" --logger trx'
        
    - task: PublishTestResults@2
      displayName: '发布测试结果'
      condition: succeededOrFailed()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/*.trx'
        
    - task: PublishCodeCoverageResults@1
      displayName: '发布代码覆盖率'
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(Agent.TempDirectory)/**/coverage.cobertura.xml'

- stage: IntegrationTests
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: IntegrationTests
    steps:
    - task: PowerShell@2
      displayName: '安装 AutoCAD'
      inputs:
        targetType: 'filePath'
        filePath: 'scripts/Install-AutoCAD.ps1'
        arguments: '-InstallerPath "$(System.DefaultWorkingDirectory)/Installers/AutoCAD2024.exe" -Silent'
        
    - task: DotNetCoreCLI@2
      displayName: '运行集成测试'
      inputs:
        command: 'test'
        projects: 'ZWDynLookup.Tests/ZWDynLookup.Tests.csproj'
        arguments: '--configuration $(buildConfiguration) --filter "Category=Integration" --logger trx'
        
    - task: DotNetCoreCLI@2
      displayName: '运行UI测试'
      inputs:
        command: 'test'
        projects: 'ZWDynLookup.Tests/ZWDynLookup.Tests.csproj'
        arguments: '--configuration $(buildConfiguration) --filter "Category=UI" --logger trx --collect:"XPlat Code Coverage"'

- stage: PerformanceTests
  dependsOn: IntegrationTests
  condition: succeeded()
  jobs:
  - job: PerformanceTests
    steps:
    - task: DotNetCoreCLI@2
      displayName: '运行性能测试'
      inputs:
        command: 'test'
        projects: 'ZWDynLookup.Tests/ZWDynLookup.Tests.csproj'
        arguments: '--configuration $(buildConfiguration) --filter "Category=Performance" --logger trx'
        
    - task: PublishTestResults@2
      displayName: '发布性能测试结果'
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/*.trx'

- stage: Package
  dependsOn: 
  - Build
  - IntegrationTests
  - PerformanceTests
  condition: succeeded()
  jobs:
  - job: Package
    steps:
    - task: DotNetCoreCLI@2
      displayName: '打包 NuGet 包'
      inputs:
        command: 'pack'
        projects: 'ZWDynLookup/ZWDynLookup.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)'
        
    - task: PublishBuildArtifacts@1
      displayName: '发布构建产物'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'packages'
```

### 2. GitHub Actions配置

#### .github/workflows/test.yml
```yaml
name: 测试工作流

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-latest
    
    strategy:
      matrix:
        dotnet-version: ['8.0.x']
        
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置 .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
        
    - name: 还原依赖
      run: dotnet restore
      
    - name: 构建
      run: dotnet build --no-restore --configuration Release
      
    - name: 运行单元测试
      run: dotnet test --no-build --configuration Release --collect:"XPlat Code Coverage" --logger trx --filter "Category=Unit"
      
    - name: 上传测试结果
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: TestResults_Unit
        path: TestResults/
        
    - name: 代码覆盖率报告
      uses: codecov/codecov-action@v3
      with:
        file: '**/coverage.cobertura.xml'
        flags: unittests
        name: codecov-umbrella

  integration-test:
    runs-on: windows-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置 .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
        
    - name: 安装 AutoCAD (模拟)
      run: |
        # 模拟安装过程
        Write-Host "模拟 AutoCAD 安装"
        
    - name: 运行集成测试
      run: dotnet test --no-build --configuration Release --logger trx --filter "Category=Integration"
      
    - name: 上传集成测试结果
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: TestResults_Integration
        path: TestResults/

  performance-test:
    runs-on: windows-latest
    needs: integration-test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置 .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
        
    - name: 运行性能测试
      run: dotnet test --no-build --configuration Release --logger trx --filter "Category=Performance"
      
    - name: 生成性能报告
      run: |
        # 生成性能报告
        dotnet run --project PerformanceAnalyzer
        
    - name: 上传性能报告
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: PerformanceReports
        path: PerformanceReports/
```

## 环境监控和诊断

### 1. 健康检查

```csharp
public class EnvironmentHealthChecker
{
    private readonly ILogger _logger;
    
    public EnvironmentHealthChecker(ILogger logger)
    {
        _logger = logger;
    }
    
    public async Task<HealthStatus> CheckEnvironmentHealth()
    {
        var status = new HealthStatus();
        
        // 检查 .NET 环境
        status.DotNetHealth = CheckDotNetEnvironment();
        
        // 检查 AutoCAD 安装
        status.AutoCADHealth = await CheckAutoCADInstallation();
        
        // 检查数据库连接
        status.DatabaseHealth = CheckDatabaseConnection();
        
        // 检查磁盘空间
        status.DiskSpaceHealth = CheckDiskSpace();
        
        // 检查内存使用
        status.MemoryHealth = CheckMemoryUsage();
        
        return status;
    }
    
    private HealthCheckResult CheckDotNetEnvironment()
    {
        try
        {
            var version = Environment.Version;
            var framework = Environment.Version.ToString();
            
            _logger.LogInformation($".NET Framework 版本: {framework}");
            
            return new HealthCheckResult
            {
                IsHealthy = true,
                Message = $".NET {framework} 环境正常"
            };
        }
        catch (Exception ex)
        {
            return new HealthCheckResult
            {
                IsHealthy = false,
                Message = $".NET 环境检查失败: {ex.Message}"
            };
        }
    }
    
    private async Task<HealthCheckResult> CheckAutoCADInstallation()
    {
        try
        {
            var cadPaths = new[]
            {
                @"C:\Program Files\Autodesk\AutoCAD 2024\acad.exe",
                @"C:\Program Files\Autodesk\AutoCAD 2023\acad.exe",
                @"C:\Program Files (x86)\Autodesk\AutoCAD 2024\acad.exe"
            };
            
            var installedPath = cadPaths.FirstOrDefault(File.Exists);
            
            if (installedPath != null)
            {
                var versionInfo = FileVersionInfo.GetVersionInfo(installedPath);
                
                return new HealthCheckResult
                {
                    IsHealthy = true,
                    Message = $"AutoCAD {versionInfo.FileVersion} 安装正常"
                };
            }
            else
            {
                return new HealthCheckResult
                {
                    IsHealthy = false,
                    Message = "未找到 AutoCAD 安装"
                };
            }
        }
        catch (Exception ex)
        {
            return new HealthCheckResult
            {
                IsHealthy = false,
                Message = $"AutoCAD 检查失败: {ex.Message}"
            };
        }
    }
    
    private HealthCheckResult CheckDatabaseConnection()
    {
        try
        {
            using var connection = new SqlConnection(GetTestConnectionString());
            connection.Open();
            
            var command = new SqlCommand("SELECT 1", connection);
            var result = command.ExecuteScalar();
            
            return new HealthCheckResult
            {
                IsHealthy = true,
                Message = "数据库连接正常"
            };
        }
        catch (Exception ex)
        {
            return new HealthCheckResult
            {
                IsHealthy = false,
                Message = $"数据库连接失败: {ex.Message}"
            };
        }
    }
    
    private HealthCheckResult CheckDiskSpace()
    {
        try
        {
            var driveInfo = new DriveInfo(Path.GetPathRoot(Environment.CurrentDirectory));
            var freeSpaceGB = driveInfo.AvailableFreeSpace / (1024 * 1024 * 1024);
            
            return new HealthCheckResult
            {
                IsHealthy = freeSpaceGB > 5, // 至少5GB可用空间
                Message = $"可用磁盘空间: {freeSpaceGB:F1}GB"
            };
        }
        catch (Exception ex)
        {
            return new HealthCheckResult
            {
                IsHealthy = false,
                Message = $"磁盘空间检查失败: {ex.Message}"
            };
        }
    }
    
    private HealthCheckResult CheckMemoryUsage()
    {
        try
        {
            var totalMemory = GC.GetTotalMemory(false);
            var memoryMB = totalMemory / (1024 * 1024);
            
            return new HealthCheckResult
            {
                IsHealthy = memoryMB < 2048, // 少于2GB
                Message = $"当前内存使用: {memoryMB}MB"
            };
        }
        catch (Exception ex)
        {
            return new HealthCheckResult
            {
                IsHealthy = false,
                Message = $"内存检查失败: {ex.Message}"
            };
        }
    }
    
    private string GetTestConnectionString()
    {
        return "Server=(localdb)\\MSSQLLocalDB;Database=ZWDynLookup_Test;Integrated Security=true;";
    }
}
```

### 2. 环境配置验证

```csharp
public class EnvironmentValidator
{
    public static ValidationResult ValidateTestEnvironment()
    {
        var result = new ValidationResult();
        
        // 验证必需的目录结构
        ValidateDirectoryStructure(result);
        
        // 验证配置文件
        ValidateConfigurationFiles(result);
        
        // 验证环境变量
        ValidateEnvironmentVariables(result);
        
        // 验证权限设置
        ValidatePermissions(result);
        
        return result;
    }
    
    private static void ValidateDirectoryStructure(ValidationResult result)
    {
        var requiredDirectories = new[]
        {
            "TestData",
            "TestData/Drawings",
            "TestData/ExpectedResults",
            "Logs",
            "Coverage",
            "TestResults"
        };
        
        foreach (var dir in requiredDirectories)
        {
            if (!Directory.Exists(dir))
            {
                result.AddError($"缺少必需目录: {dir}");
            }
        }
    }
    
    private static void ValidateConfigurationFiles(ValidationResult result)
    {
        var configFiles = new[]
        {
            "TestConfig.json",
            "TestData.json"
        };
        
        foreach (var configFile in configFiles)
        {
            if (!File.Exists(configFile))
            {
                result.AddError($"缺少配置文件: {configFile}");
            }
            else
            {
                // 验证JSON格式
                try
                {
                    var content = File.ReadAllText(configFile);
                    JsonDocument.Parse(content);
                }
                catch (JsonException)
                {
                    result.AddError($"配置文件格式错误: {configFile}");
                }
            }
        }
    }
    
    private static void ValidateEnvironmentVariables(ValidationResult result)
    {
        var requiredVars = new[]
        {
            "TEST_ENVIRONMENT",
            "AUTOCAD_VERSION"
        };
        
        foreach (var varName in requiredVars)
        {
            var value = Environment.GetEnvironmentVariable(varName);
            if (string.IsNullOrEmpty(value))
            {
                result.AddWarning($"环境变量未设置: {varName}");
            }
        }
    }
}
```

## 故障排除指南

### 1. 常见问题及解决方案

#### AutoCAD启动失败
```powershell
# 诊断脚本
function Diagnose-AutoCAD {
    Write-Host "诊断 AutoCAD 安装..." -ForegroundColor Yellow
    
    # 检查安装路径
    $installPaths = @(
        "C:\Program Files\Autodesk\AutoCAD 2024",
        "C:\Program Files (x86)\Autodesk\AutoCAD 2024"
    )
    
    foreach ($path in $installPaths) {
        if (Test-Path $path) {
            Write-Host "找到安装路径: $path" -ForegroundColor Green
            $acadExe = Join-Path $path "acad.exe"
            if (Test-Path $acadExe) {
                Write-Host "acad.exe 存在" -ForegroundColor Green
                return $true
            }
        }
    }
    
    Write-Host "未找到 AutoCAD 安装" -ForegroundColor Red
    return $false
}

# 执行诊断
Diagnose-AutoCAD
```

#### 数据库连接问题
```csharp
public class DatabaseDiagnostics
{
    public static void DiagnoseConnectionIssues()
    {
        Console.WriteLine("诊断数据库连接问题...");
        
        // 检查 LocalDB 安装
        CheckLocalDBInstallation();
        
        // 检查数据库文件
        CheckDatabaseFiles();
        
        // 检查权限
        CheckDatabasePermissions();
        
        // 测试连接字符串
        TestConnectionStrings();
    }
    
    private static void CheckLocalDBInstallation()
    {
        try
        {
            var processInfo = new ProcessStartInfo
            {
                FileName = "sqllocaldb",
                Arguments = "info",
                UseShellExecute = false,
                RedirectStandardOutput = true,
                CreateNoWindow = true
            };
            
            using var process = Process.Start(processInfo);
            var output = process.StandardOutput.ReadToEnd();
            process.WaitForExit();
            
            Console.WriteLine($"LocalDB 实例: {output}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"LocalDB 检查失败: {ex.Message}");
        }
    }
}
```

### 2. 日志记录和分析

```csharp
public class TestExecutionLogger
{
    private readonly string _logDirectory;
    private readonly ILogger _logger;
    
    public TestExecutionLogger(string logDirectory)
    {
        _logDirectory = logDirectory;
        Directory.CreateDirectory(logDirectory);
        
        var loggerFactory = LoggerFactory.Create(builder =>
        {
            builder.AddFile(Path.Combine(logDirectory, "test-execution-{Date}.log"));
            builder.SetMinimumLevel(LogLevel.Information);
        });
        
        _logger = loggerFactory.CreateLogger<TestExecutionLogger>();
    }
    
    public void LogTestExecution(TestContext testContext, TestOutcome outcome)
    {
        var logEntry = new TestExecutionLog
        {
            TestName = testContext.TestName,
            TestClass = testContext.FullyQualifiedTestClassName,
            StartTime = DateTime.Now,
            EndTime = DateTime.Now,
            Outcome = outcome.ToString(),
            TestMethodName = testContext.TestName
        };
        
        _logger.LogInformation("测试执行: {TestName}, 结果: {Outcome}", 
            logEntry.TestName, logEntry.Outcome);
    }
    
    public void LogPerformanceMetrics(string testName, PerformanceMetrics metrics)
    {
        _logger.LogInformation("性能指标 - 测试: {TestName}, 执行时间: {Elapsed}ms, 内存: {Memory}MB",
            testName, metrics.ElapsedMilliseconds, metrics.MemoryUsedMB);
    }
}
```

---

*本指南为ZWDynLookup项目提供了完整的测试环境配置框架，确保测试环境的稳定性、可重现性和可维护性。*