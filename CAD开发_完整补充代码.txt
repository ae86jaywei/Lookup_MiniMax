ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶ - å®Œæ•´è¡¥å……ä»£ç 
===========================================

ğŸ’¡ è¿™æ˜¯å¯¹ä¹‹å‰ä»£ç çš„å®Œæ•´è¡¥å……ï¼ŒåŒ…å«æ‰€æœ‰ç¼ºå¤±çš„é‡è¦å®ç°

ğŸ“ 1. å®Œæ•´çš„PluginEntry.cså®ç°
=========================================

using System;
using System.IO;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Windows.Forms;
using ZwSoft.ZwCAD.ApplicationServices;
using ZwSoft.ZwCAD.DatabaseServices;
using ZwSoft.ZwCAD.EditorInput;
using ZwSoft.ZwCAD.Runtime;
using ZwSoft.ZwCAD.Windows;
using System.Collections.Generic;

namespace ZWDynLookup
{
    /// <summary>
    /// ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶ä¸»å…¥å£ç±»
    /// å®ç°IExtensionApplicationæ¥å£
    /// </summary>
    [Guid("A1B2C3D4-E5F6-7890-ABCD-123456789012")]
    [Assembly: AssemblyVersion("1.0.0.0")]
    [Assembly: AssemblyFileVersion("1.0.0.0")]
    [AssemblyDescription("ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶")]
    [AssemblyTitle("ZWDynLookup Plugin")]
    [AssemblyCompany("ZWCAD Development")]
    public class PluginEntry : IExtensionApplication
    {
        private static readonly string LogFilePath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments),
            "ZWDynLookup", "Plugin.log");

        private static Dictionary<string, Type> _commandTypes;
        private static PaletteSet _mainPalette;
        private static bool _isInitialized = false;

        /// <summary>
        /// æ’ä»¶åˆå§‹åŒ–
        /// </summary>
        public void Initialize()
        {
            try
            {
                Log("=== æ’ä»¶å¼€å§‹åˆå§‹åŒ– ===");
                
                // åˆ›å»ºæ—¥å¿—ç›®å½•
                Directory.CreateDirectory(Path.GetDirectoryName(LogFilePath));
                
                // åˆå§‹åŒ–å‘½ä»¤ç±»å‹å­—å…¸
                InitializeCommandTypes();
                
                // æ³¨å†Œæ‰€æœ‰å‘½ä»¤
                RegisterCommands();
                
                // åˆå§‹åŒ–UIç»„ä»¶
                InitializeUI();
                
                // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
                RegisterEventHandlers();
                
                Log("æ’ä»¶åˆå§‹åŒ–å®Œæˆ");
                _isInitialized = true;
                
                // æ˜¾ç¤ºåˆå§‹åŒ–æ¶ˆæ¯
                ShowInitializationMessage();
            }
            catch (Exception ex)
            {
                Log($"æ’ä»¶åˆå§‹åŒ–å¤±è´¥: {ex.Message}");
                ShowError($"æ’ä»¶åˆå§‹åŒ–å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// æ’ä»¶å¸è½½
        /// </summary>
        public void Terminate()
        {
            try
            {
                Log("=== æ’ä»¶å¼€å§‹å¸è½½ ===");
                
                // å–æ¶ˆäº‹ä»¶å¤„ç†å™¨æ³¨å†Œ
                UnregisterEventHandlers();
                
                // æ¸…ç†UIèµ„æº
                DisposeUI();
                
                Log("æ’ä»¶å¸è½½å®Œæˆ");
            }
            catch (Exception ex)
            {
                Log($"æ’ä»¶å¸è½½å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆå§‹åŒ–å‘½ä»¤ç±»å‹å­—å…¸
        /// </summary>
        private void InitializeCommandTypes()
        {
            _commandTypes = new Dictionary<string, Type>
            {
                { "ZWBPARAMETER", typeof(Commands.BParameterCommand) },
                { "ZWBACTIONTOOL", typeof(Commands.BActionToolCommand) },
                { "ZWBLOOKUPTABLE", typeof(Commands.LookupTableCommand) },
                { "ZWBPROPERTIES", typeof(Commands.PropertiesCommand) },
                { "ZWBGRIPS", typeof(Commands.GripsCommand) },
                { "ZWBTAGS", typeof(Commands.TagsCommand) },
                { "ZWBCLEAR", typeof(Commands.ClearCommand) }
            };
        }

        /// <summary>
        /// æ³¨å†Œæ‰€æœ‰å‘½ä»¤
        /// </summary>
        private void RegisterCommands()
        {
            try
            {
                Log("å¼€å§‹æ³¨å†Œå‘½ä»¤...");
                
                foreach (var commandType in _commandTypes)
                {
                    RegisterSingleCommand(commandType.Key, commandType.Value);
                }
                
                Log($"å‘½ä»¤æ³¨å†Œå®Œæˆï¼Œå…±æ³¨å†Œ {_commandTypes.Count} ä¸ªå‘½ä»¤");
            }
            catch (Exception ex)
            {
                Log($"å‘½ä»¤æ³¨å†Œå¤±è´¥: {ex.Message}");
                throw;
            }
        }

        /// <summary>
        /// æ³¨å†Œå•ä¸ªå‘½ä»¤
        /// </summary>
        private void RegisterSingleCommand(string commandName, Type commandType)
        {
            try
            {
                // ä½¿ç”¨CommandMethodç‰¹æ€§è‡ªåŠ¨æ³¨å†Œ
                Log($"æ³¨å†Œå‘½ä»¤: {commandName} -> {commandType.Name}");
            }
            catch (Exception ex)
            {
                Log($"æ³¨å†Œå‘½ä»¤ {commandName} å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆå§‹åŒ–UIç»„ä»¶
        /// </summary>
        private void InitializeUI()
        {
            try
            {
                Log("åˆå§‹åŒ–UIç»„ä»¶...");
                
                // åˆ›å»ºä¸»é¢æ¿
                CreateMainPalette();
                
                Log("UIç»„ä»¶åˆå§‹åŒ–å®Œæˆ");
            }
            catch (Exception ex)
            {
                Log($"UIç»„ä»¶åˆå§‹åŒ–å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆ›å»ºä¸»é¢æ¿
        /// </summary>
        private void CreateMainPalette()
        {
            try
            {
                if (_mainPalette == null)
                {
                    _mainPalette = new PaletteSet("åŠ¨æ€å—æŸ¥å¯»ç®¡ç†å™¨", new Guid("DYNBLOCK-MANAGER-GUID"));
                    _mainPalette.Style = PaletteSetStyles.ShowAutoHideButton | 
                                        PaletteSetStyles.ShowCloseButton |
                                        PaletteSetStyles.Snappable;
                    
                    // è¿™é‡Œå¯ä»¥æ·»åŠ UIæ§ä»¶
                    // var control = new UI.MainControl();
                    // _mainPalette.Add("ä¸»é¢æ¿", control);
                }
            }
            catch (Exception ex)
            {
                Log($"åˆ›å»ºä¸»é¢æ¿å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// æ˜¾ç¤ºä¸»é¢æ¿
        /// </summary>
        public static void ShowMainPalette()
        {
            try
            {
                if (_mainPalette != null)
                {
                    _mainPalette.Visible = true;
                }
            }
            catch (Exception ex)
            {
                Log($"æ˜¾ç¤ºä¸»é¢æ¿å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
        /// </summary>
        private void RegisterEventHandlers()
        {
            try
            {
                // æ³¨å†Œæ–‡æ¡£äº‹ä»¶
                Application.DocumentManager.DocumentCreated += OnDocumentCreated;
                Application.DocumentManager.DocumentActivated += OnDocumentActivated;
                Application.DocumentManager.DocumentToBeDestroyed += OnDocumentToBeDestroyed;
                
                // æ³¨å†Œåº”ç”¨ç¨‹åºäº‹ä»¶
                Application.ApplicationEvents.DocumentLockChanged += OnDocumentLockChanged;
                
                Log("äº‹ä»¶å¤„ç†å™¨æ³¨å†Œå®Œæˆ");
            }
            catch (Exception ex)
            {
                Log($"æ³¨å†Œäº‹ä»¶å¤„ç†å™¨å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// å–æ¶ˆäº‹ä»¶å¤„ç†å™¨æ³¨å†Œ
        /// </summary>
        private void UnregisterEventHandlers()
        {
            try
            {
                Application.DocumentManager.DocumentCreated -= OnDocumentCreated;
                Application.DocumentManager.DocumentActivated -= OnDocumentActivated;
                Application.DocumentManager.DocumentToBeDestroyed -= OnDocumentToBeDestroyed;
                Application.ApplicationEvents.DocumentLockChanged -= OnDocumentLockChanged;
                
                Log("äº‹ä»¶å¤„ç†å™¨å–æ¶ˆæ³¨å†Œå®Œæˆ");
            }
            catch (Exception ex)
            {
                Log($"å–æ¶ˆäº‹ä»¶å¤„ç†å™¨æ³¨å†Œå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// æ˜¾ç¤ºåˆå§‹åŒ–æ¶ˆæ¯
        /// </summary>
        private void ShowInitializationMessage()
        {
            try
            {
                var editor = GetEditor();
                if (editor != null)
                {
                    editor.WriteMessage("\n" + new string('=', 60));
                    editor.WriteMessage("ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶å·²åŠ è½½");
                    editor.WriteMessage(new string('=', 60));
                    editor.WriteMessage("å¯ç”¨å‘½ä»¤:");
                    editor.WriteMessage("  ZWBPARAMETER   - åˆ›å»ºæŸ¥å¯»å‚æ•° (å¯¹åº”BPARAMETER K)");
                    editor.WriteMessage("  ZWBACTIONTOOL  - åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ (å¯¹åº”BACTIONTOOL L)");
                    editor.WriteMessage("  ZWBLOOKUPTABLE - ç®¡ç†æŸ¥å¯»è¡¨");
                    editor.WriteMessage("  ZWBPROPERTIES  - ç®¡ç†å‚æ•°ç‰¹æ€§");
                    editor.WriteMessage("  ZWBGRIPS       - é«˜äº®æ˜¾ç¤ºå¤¹ç‚¹");
                    editor.WriteMessage("  ZWBTAGS        - æ˜¾ç¤ºå‚æ•°æ ‡ç­¾");
                    editor.WriteMessage("  ZWBCLEAR       - æ¸…é™¤é«˜äº®å’Œä¸´æ—¶å¯¹è±¡");
                    editor.WriteMessage("ä½¿ç”¨æ–¹æ³•:");
                    editor.WriteMessage("  1. è¿›å…¥å—ç¼–è¾‘å™¨");
                    editor.WriteMessage("  2. ä½¿ç”¨ ZWBPARAMETER åˆ›å»ºæŸ¥å¯»å‚æ•°");
                    editor.WriteMessage("  3. ä½¿ç”¨ ZWBACTIONTOOL åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ");
                    editor.WriteMessage("  4. é…ç½®æŸ¥å¯»è¡¨å’Œç‰¹æ€§");
                    editor.WriteMessage("  5. å…³é—­å—ç¼–è¾‘å™¨ï¼Œæµ‹è¯•æŸ¥å¯»åŠŸèƒ½");
                    editor.WriteMessage(new string('=', 60));
                }
            }
            catch (Exception ex)
            {
                Log($"æ˜¾ç¤ºåˆå§‹åŒ–æ¶ˆæ¯å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// äº‹ä»¶å¤„ç†å™¨ï¼šæ–‡æ¡£åˆ›å»º
        /// </summary>
        private void OnDocumentCreated(object sender, DocumentCollectionEventArgs e)
        {
            Log($"æ–°æ–‡æ¡£åˆ›å»º: {e.Document?.Name}");
        }

        /// <summary>
        /// äº‹ä»¶å¤„ç†å™¨ï¼šæ–‡æ¡£æ¿€æ´»
        /// </summary>
        private void OnDocumentActivated(object sender, DocumentCollectionEventArgs e)
        {
            Log($"æ–‡æ¡£æ¿€æ´»: {e.Document?.Name}");
        }

        /// <summary>
        /// äº‹ä»¶å¤„ç†å™¨ï¼šæ–‡æ¡£å³å°†é”€æ¯
        /// </summary>
        private void OnDocumentToBeDestroyed(object sender, DocumentCollectionEventArgs e)
        {
            Log($"æ–‡æ¡£å³å°†é”€æ¯: {e.Document?.Name}");
        }

        /// <summary>
        /// äº‹ä»¶å¤„ç†å™¨ï¼šæ–‡æ¡£é”å®šå˜æ›´
        /// </summary>
        private void OnDocumentLockChanged(object sender, DocumentLockChangedEventArgs e)
        {
            Log($"æ–‡æ¡£é”å®šå˜æ›´: {e.Document?.Name}, Locked: {e.Locked}");
        }

        /// <summary>
        /// è·å–å½“å‰æ´»åŠ¨æ–‡æ¡£
        /// </summary>
        public static Document GetActiveDocument()
        {
            return Application.DocumentManager.MdiActiveDocument;
        }

        /// <summary>
        /// è·å–ç¼–è¾‘å™¨
        /// </summary>
        public static Editor GetEditor()
        {
            var doc = GetActiveDocument();
            return doc?.Editor;
        }

        /// <summary>
        /// è·å–æ•°æ®åº“
        /// </summary>
        public static Database GetDatabase()
        {
            var doc = GetActiveDocument();
            return doc?.Database;
        }

        /// <summary>
        /// è®°å½•æ—¥å¿—
        /// </summary>
        public static void Log(string message)
        {
            try
            {
                var logEntry = $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss.fff}] {message}";
                File.AppendAllText(LogFilePath, logEntry + Environment.NewLine);
            }
            catch
            {
                // å¿½ç•¥æ—¥å¿—å†™å…¥é”™è¯¯
            }
        }

        /// <summary>
        /// æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        /// </summary>
        public static void ShowError(string message)
        {
            var editor = GetEditor();
            if (editor != null)
            {
                editor.WriteMessage($"\né”™è¯¯: {message}");
            }
            
            Log($"é”™è¯¯: {message}");
        }

        /// <summary>
        /// æ˜¾ç¤ºä¿¡æ¯æ¶ˆæ¯
        /// </summary>
        public static void ShowInfo(string message)
        {
            var editor = GetEditor();
            if (editor != null)
            {
                editor.WriteMessage($"\nä¿¡æ¯: {message}");
            }
            
            Log($"ä¿¡æ¯: {message}");
        }

        /// <summary>
        /// æ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
        /// </summary>
        public static void ShowWarning(string message)
        {
            var editor = GetEditor();
            if (editor != null)
            {
                editor.WriteMessage($"\nè­¦å‘Š: {message}");
            }
            
            Log($"è­¦å‘Š: {message}");
        }

        /// <summary>
        /// æ˜¾ç¤ºè°ƒè¯•æ¶ˆæ¯
        /// </summary>
        public static void ShowDebug(string message)
        {
            Log($"è°ƒè¯•: {message}");
        }

        /// <summary>
        /// æ¸…ç†UIèµ„æº
        /// </summary>
        private void DisposeUI()
        {
            try
            {
                if (_mainPalette != null)
                {
                    _mainPalette.Dispose();
                    _mainPalette = null;
                }
            }
            catch (Exception ex)
            {
                Log($"æ¸…ç†UIèµ„æºå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// è·å–å‘½ä»¤ç±»å‹
        /// </summary>
        public static Type GetCommandType(string commandName)
        {
            if (_commandTypes != null && _commandTypes.ContainsKey(commandName))
            {
                return _commandTypes[commandName];
            }
            return null;
        }

        /// <summary>
        /// æ£€æŸ¥æ’ä»¶æ˜¯å¦å·²åˆå§‹åŒ–
        /// </summary>
        public static bool IsInitialized()
        {
            return _isInitialized;
        }
    }
}

===========================================
ğŸ“ 2. å®Œæ•´çš„BParameterCommand.cså®ç°
=========================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Windows;
using ZwSoft.ZwCAD.ApplicationServices;
using ZwSoft.ZwCAD.DatabaseServices;
using ZwSoft.ZwCAD.EditorInput;
using ZwSoft.ZwCAD.Geometry;
using ZwSoft.ZwCAD.Runtime;
using ZwSoft.ZwCAD.Windows;
using ZWDynLookup.UI;
using ZWDynLookup.Models;
using ZWDynLookup.Service;

namespace ZWDynLookup.Commands
{
    /// <summary>
    /// BPARAMETERå‘½ä»¤ - åˆ›å»ºæŸ¥å¯»å‚æ•°
    /// å®ç°Ké€‰é¡¹ï¼ˆæŸ¥å¯»å‚æ•°ï¼‰åŠŸèƒ½
    /// å¯¹åº”AutoCADçš„BPARAMETER Kå‘½ä»¤
    /// </summary>
    [CommandMethod("ZWBPARAMETER")]
    public class BParameterCommand
    {
        private string _parameterName = "LookupParameter";
        private string _label = "æ ‡ç­¾";
        private string _description = "æŸ¥å¯»å‚æ•°æè¿°";
        private bool _showPalette = true;
        private int _gripCount = 1;
        private string _associatedParameter = "";

        private LookupParameterCreator _parameterCreator;
        private ParameterPointManager _pointManager;
        private GripManager _gripManager;
        private LookupParameter _currentParameter;
        private Document _currentDocument;
        private Database _currentDatabase;

        /// <summary>
        /// æ‰§è¡ŒBPARAMETERå‘½ä»¤
        /// </summary>
        public void Execute()
        {
            try
            {
                PluginEntry.Log("å¼€å§‹æ‰§è¡ŒZWBPARAMETERå‘½ä»¤");

                _currentDocument = PluginEntry.GetActiveDocument();
                if (_currentDocument == null)
                {
                    PluginEntry.ShowError("æ²¡æœ‰æ´»åŠ¨çš„CADæ–‡æ¡£");
                    return;
                }

                _currentDatabase = _currentDocument.Database;
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å—ç¼–è¾‘å™¨ä¸­
                if (!_currentDocument.Editor.IsInBlockEditor())
                {
                    PluginEntry.ShowWarning("è¯·åœ¨å—ç¼–è¾‘å™¨ä¸­ä½¿ç”¨æ­¤å‘½ä»¤");
                    return;
                }

                // åˆå§‹åŒ–ç®¡ç†å™¨
                InitializeManagers();

                // å¼€å§‹å‚æ•°åˆ›å»ºæµç¨‹
                StartParameterCreationFlow();
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"ZWBPARAMETERå‘½ä»¤æ‰§è¡Œå¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"å‘½ä»¤æ‰§è¡Œå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆå§‹åŒ–ç®¡ç†å™¨
        /// </summary>
        private void InitializeManagers()
        {
            _parameterCreator = new LookupParameterCreator();
            _pointManager = new ParameterPointManager();
            _gripManager = new GripManager();
        }

        /// <summary>
        /// å¼€å§‹å‚æ•°åˆ›å»ºæµç¨‹
        /// </summary>
        private void StartParameterCreationFlow()
        {
            var editor = PluginEntry.GetEditor();
            if (editor == null) return;

            editor.WriteMessage("\n" + new string('=', 50));
            editor.WriteMessage("BPARAMETER - æŸ¥å¯»å‚æ•°åˆ›å»º");
            editor.WriteMessage(new string('=', 50));
            editor.WriteMessage("é€‰é¡¹: [åç§°(N)/æ ‡ç­¾(L)/è¯´æ˜(D)/å…³è”å‚æ•°(A)/é€‰é¡¹æ¿(P)]");
            editor.WriteMessage("è¾“å…¥å¤¹ç‚¹æ•° [0/1]æˆ–æ‹¾å–: ");

            // è·å–å‚æ•°åç§°
            GetParameterName(editor);
        }

        /// <summary>
        /// è·å–å‚æ•°åç§°
        /// </summary>
        private void GetParameterName(Editor editor)
        {
            var options = new PromptStringOptions("\nè¾“å…¥å‚æ•°åç§°æˆ– [åç§°(N)]: ");
            options.AllowSpaces = true;
            options.DefaultValue = _parameterName;

            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                if (!string.IsNullOrEmpty(result.StringResult))
                {
                    _parameterName = result.StringResult;
                }
                GetParameterLabel(editor);
            }
            else if (result.Status == PromptStatus.Keyword && 
                     result.StringResult.Equals("N", StringComparison.OrdinalIgnoreCase))
            {
                // æ˜ç¡®æŒ‡å®šåç§°é€‰é¡¹
                GetExplicitParameterName(editor);
            }
            else
            {
                // å–æ¶ˆæ“ä½œ
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
                return;
            }
        }

        /// <summary>
        /// æ˜ç¡®æŒ‡å®šå‚æ•°åç§°
        /// </summary>
        private void GetExplicitParameterName(Editor editor)
        {
            var nameOptions = new PromptStringOptions("è¾“å…¥å‚æ•°åç§°: ");
            nameOptions.AllowSpaces = false;

            var nameResult = editor.GetString(nameOptions);
            if (nameResult.Status == PromptStatus.OK && !string.IsNullOrEmpty(nameResult.StringResult))
            {
                _parameterName = nameResult.StringResult;
                GetParameterLabel(editor);
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
                return;
            }
        }

        /// <summary>
        /// è·å–å‚æ•°æ ‡ç­¾
        /// </summary>
        private void GetParameterLabel(Editor editor)
        {
            var options = new PromptStringOptions($"\nè¾“å…¥æ ‡ç­¾æˆ– [æ ‡ç­¾(L)] (å½“å‰: {_label}): ");
            options.AllowSpaces = true;
            options.DefaultValue = _label;

            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                if (!string.IsNullOrEmpty(result.StringResult))
                {
                    _label = result.StringResult;
                }
                GetParameterDescription(editor);
            }
            else if (result.Status == PromptStatus.Keyword && 
                     result.StringResult.Equals("L", StringComparison.OrdinalIgnoreCase))
            {
                GetExplicitParameterLabel(editor);
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
                return;
            }
        }

        /// <summary>
        /// æ˜ç¡®æŒ‡å®šå‚æ•°æ ‡ç­¾
        /// </summary>
        private void GetExplicitParameterLabel(Editor editor)
        {
            var labelOptions = new PromptStringOptions("è¾“å…¥æ ‡ç­¾: ");
            labelOptions.AllowSpaces = true;

            var labelResult = editor.GetString(labelOptions);
            if (labelResult.Status == PromptStatus.OK)
            {
                _label = labelResult.StringResult;
                GetParameterDescription(editor);
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
                return;
            }
        }

        /// <summary>
        /// è·å–å‚æ•°è¯´æ˜
        /// </summary>
        private void GetParameterDescription(Editor editor)
        {
            var options = new PromptStringOptions($"\nè¾“å…¥è¯´æ˜æˆ– [è¯´æ˜(D)] (å½“å‰: {_description}): ");
            options.AllowSpaces = true;
            options.DefaultValue = _description;

            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                if (!string.IsNullOrEmpty(result.StringResult))
                {
                    _description = result.StringResult;
                }
                GetAssociatedParameter(editor);
            }
            else if (result.Status == PromptStatus.Keyword && 
                     result.StringResult.Equals("D", StringComparison.OrdinalIgnoreCase))
            {
                GetExplicitParameterDescription(editor);
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
                return;
            }
        }

        /// <summary>
        /// æ˜ç¡®æŒ‡å®šå‚æ•°è¯´æ˜
        /// </summary>
        private void GetExplicitParameterDescription(Editor editor)
        {
            var descOptions = new PromptStringOptions("è¾“å…¥è¯´æ˜: ");
            descOptions.AllowSpaces = true;

            var descResult = editor.GetString(descOptions);
            if (descResult.Status == PromptStatus.OK)
            {
                _description = descResult.StringResult;
                GetAssociatedParameter(editor);
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
                return;
            }
        }

        /// <summary>
        /// è·å–å…³è”å‚æ•°
        /// </summary>
        private void GetAssociatedParameter(Editor editor)
        {
            var options = new PromptStringOptions("\nè¾“å…¥å…³è”å‚æ•°åç§°æˆ– [å…³è”å‚æ•°(A)] (å¯é€‰): ");
            options.AllowSpaces = true;

            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                _associatedParameter = result.StringResult;
                GetGripCount(editor);
            }
            else if (result.Status == PromptStatus.Keyword && 
                     result.StringResult.Equals("A", StringComparison.OrdinalIgnoreCase))
            {
                GetExplicitAssociatedParameter(editor);
            }
            else
            {
                // æ²¡æœ‰å…³è”å‚æ•°ï¼Œç»§ç»­
                _associatedParameter = "";
                GetGripCount(editor);
            }
        }

        /// <summary>
        /// æ˜ç¡®æŒ‡å®šå…³è”å‚æ•°
        /// </summary>
        private void GetExplicitAssociatedParameter(Editor editor)
        {
            var assocOptions = new PromptStringOptions("è¾“å…¥å…³è”å‚æ•°åç§°: ");
            assocOptions.AllowSpaces = false;

            var assocResult = editor.GetString(assocOptions);
            if (assocResult.Status == PromptStatus.OK)
            {
                _associatedParameter = assocResult.StringResult;
                GetGripCount(editor);
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
                return;
            }
        }

        /// <summary>
        /// è·å–å¤¹ç‚¹æ•°
        /// </summary>
        private void GetGripCount(Editor editor)
        {
            var keywordOptions = new PromptKeywordOptions($"\nè¾“å…¥å¤¹ç‚¹æ•° [0/1]æˆ–æ‹¾å– (å½“å‰: {_gripCount}): ");
            keywordOptions.Keywords.Add("0", "0", "0ä¸ªå¤¹ç‚¹");
            keywordOptions.Keywords.Add("1", "1", "1ä¸ªå¤¹ç‚¹");
            keywordOptions.Keywords.Add("PICK", "P", "æ‹¾å–");
            keywordOptions.AllowNone = true;

            var result = editor.GetKeywords(keywordOptions);
            if (result.Status == PromptStatus.OK)
            {
                switch (result.StringResult.ToUpper())
                {
                    case "0":
                        _gripCount = 0;
                        break;
                    case "1":
                        _gripCount = 1;
                        break;
                    case "PICK":
                        // ä½¿ç”¨æ‹¾å–æ¨¡å¼
                        PickParameterPoint(editor);
                        return;
                }
                
                // ç›´æ¥åˆ›å»ºå‚æ•°
                CreateParameter(editor, null);
            }
            else if (result.Status == PromptStatus.None)
            {
                // ä½¿ç”¨å½“å‰å€¼
                CreateParameter(editor, null);
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
                return;
            }
        }

        /// <summary>
        /// æ‹¾å–å‚æ•°ç‚¹
        /// </summary>
        private void PickParameterPoint(Editor editor)
        {
            editor.WriteMessage("\næ‹¾å–å‚æ•°ç‚¹ä½ç½®: ");
            var pointOptions = new PromptPointOptions("æŒ‡å®šå‚æ•°ç‚¹ä½ç½®: ");
            pointOptions.AllowNone = false;

            var result = editor.GetPoint(pointOptions);
            if (result.Status == PromptStatus.OK)
            {
                CreateParameter(editor, result.Value);
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
                return;
            }
        }

        /// <summary>
        /// åˆ›å»ºå‚æ•°
        /// </summary>
        private void CreateParameter(Editor editor, Point3d? position)
        {
            try
            {
                editor.WriteMessage("\næ­£åœ¨åˆ›å»ºæŸ¥å¯»å‚æ•°...");

                // éªŒè¯å‚æ•°åç§°
                if (!IsValidParameterName(_parameterName))
                {
                    editor.WriteMessage($"\né”™è¯¯: å‚æ•°åç§° '{_parameterName}' åŒ…å«æ— æ•ˆå­—ç¬¦");
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåå‚æ•°
                if (ParameterExists(_parameterName))
                {
                    editor.WriteMessage($"\nè­¦å‘Š: å‚æ•°åç§° '{_parameterName}' å·²å­˜åœ¨ï¼Œå°†è¢«è¦†ç›–");
                }

                // ä½¿ç”¨é»˜è®¤ä½ç½®æˆ–æŒ‡å®šä½ç½®
                Point3d paramPosition = position ?? new Point3d(0, 0, 0);

                // åˆ›å»ºæŸ¥å¯»å‚æ•°å¯¹è±¡
                _currentParameter = new LookupParameter
                {
                    Name = _parameterName,
                    Label = _label,
                    Description = _description,
                    Position = paramPosition,
                    GripCount = _gripCount,
                    AssociatedParameter = _associatedParameter,
                    CreationTime = DateTime.Now,
                    IsVisible = true
                };

                // åˆ›å»ºæŸ¥å¯»å‚æ•°
                if (_parameterCreator.CreateLookupParameter(_currentParameter, _currentDatabase))
                {
                    // åˆ›å»ºå¤¹ç‚¹
                    if (_gripCount > 0)
                    {
                        _gripManager.CreateParameterGrip(_currentParameter, paramPosition);
                    }

                    // åˆ›å»ºå‚æ•°ç‚¹
                    _pointManager.CreateParameterPoint(_currentParameter);

                    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    DisplayCreationSuccess(editor, paramPosition);

                    // è¯¢é—®æ˜¯å¦æ˜¾ç¤ºå±æ€§å¯¹è¯æ¡†
                    ShowParameterPropertiesDialogIfNeeded(editor);
                }
                else
                {
                    editor.WriteMessage("\né”™è¯¯: æŸ¥å¯»å‚æ•°åˆ›å»ºå¤±è´¥");
                    PluginEntry.Log($"æŸ¥å¯»å‚æ•°åˆ›å»ºå¤±è´¥: {_parameterName}");
                }
            }
            catch (Exception ex)
            {
                editor.WriteMessage($"\né”™è¯¯: åˆ›å»ºå‚æ•°æ—¶å‘ç”Ÿå¼‚å¸¸ - {ex.Message}");
                PluginEntry.Log($"åˆ›å»ºå‚æ•°å¼‚å¸¸: {ex.Message}");
                PluginEntry.Log($"å¼‚å¸¸è¯¦æƒ…: {ex.StackTrace}");
            }
        }

        /// <summary>
        /// éªŒè¯å‚æ•°åç§°
        /// </summary>
        private bool IsValidParameterName(string name)
        {
            if (string.IsNullOrEmpty(name))
                return false;

            // æ£€æŸ¥æ˜¯å¦åŒ…å«CADä¿ç•™å­—ç¬¦
            char[] invalidChars = { '<', '>', '|', ':', '*', '?', '"' };
            return !name.Any(c => invalidChars.Contains(c));
        }

        /// <summary>
        /// æ£€æŸ¥å‚æ•°æ˜¯å¦å·²å­˜åœ¨
        /// </summary>
        private bool ParameterExists(string parameterName)
        {
            try
            {
                return _pointManager.ParameterExists(parameterName);
            }
            catch
            {
                return false;
            }
        }

        /// <summary>
        /// æ˜¾ç¤ºåˆ›å»ºæˆåŠŸä¿¡æ¯
        /// </summary>
        private void DisplayCreationSuccess(Editor editor, Point3d position)
        {
            editor.WriteMessage("\n" + new string('=', 50));
            editor.WriteMessage("æŸ¥å¯»å‚æ•°åˆ›å»ºæˆåŠŸ");
            editor.WriteMessage(new string('=', 50));
            editor.WriteMessage($"å‚æ•°åç§°: {_parameterName}");
            editor.WriteMessage($"æ ‡ç­¾: {_label}");
            editor.WriteMessage($"è¯´æ˜: {_description}");
            editor.WriteMessage($"ä½ç½®: ({position.X:F2}, {position.Y:F2}, {position.Z:F2})");
            editor.WriteMessage($"å¤¹ç‚¹æ•°: {_gripCount}");
            if (!string.IsNullOrEmpty(_associatedParameter))
            {
                editor.WriteLine($"å…³è”å‚æ•°: {_associatedParameter}");
            }
            editor.WriteMessage(new string('=', 50));

            PluginEntry.Log($"æŸ¥å¯»å‚æ•°åˆ›å»ºæˆåŠŸ: {_parameterName}");
        }

        /// <summary>
        /// æ˜¾ç¤ºå‚æ•°å±æ€§å¯¹è¯æ¡†ï¼ˆå¦‚æœéœ€è¦ï¼‰
        /// </summary>
        private void ShowParameterPropertiesDialogIfNeeded(Editor editor)
        {
            try
            {
                var keywordOptions = new PromptKeywordOptions("\næ˜¯å¦æ˜¾ç¤ºå‚æ•°å±æ€§å¯¹è¯æ¡† [æ˜¯(Y)/å¦(N)]: ");
                keywordOptions.Keywords.Add("Y", "Y", "æ˜¯");
                keywordOptions.Keywords.Add("N", "N", "å¦");
                keywordOptions.AllowNone = true;

                var result = editor.GetKeywords(keywordOptions);
                if (result.Status == PromptStatus.OK && result.StringResult.Equals("Y", StringComparison.OrdinalIgnoreCase))
                {
                    ShowParameterPropertiesDialog();
                }
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"æ˜¾ç¤ºå‚æ•°å±æ€§å¯¹è¯æ¡†å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// æ˜¾ç¤ºå‚æ•°å±æ€§å¯¹è¯æ¡†
        /// </summary>
        private void ShowParameterPropertiesDialog()
        {
            try
            {
                var dialog = new ParameterPropertiesDialog(_currentParameter);
                
                // åœ¨CADçº¿ç¨‹ä¸­æ˜¾ç¤ºå¯¹è¯æ¡†
                Application.InvokeOnCadThread(() =>
                {
                    dialog.ShowDialog();
                    
                    if (dialog.DialogResult == true)
                    {
                        // ä¿å­˜ä¿®æ”¹åçš„å‚æ•°
                        UpdateParameter(dialog.GetUpdatedParameter());
                    }
                });
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"æ˜¾ç¤ºå‚æ•°å±æ€§å¯¹è¯æ¡†å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// æ›´æ–°å‚æ•°
        /// </summary>
        private void UpdateParameter(LookupParameter updatedParameter)
        {
            try
            {
                if (_parameterCreator.UpdateLookupParameter(updatedParameter, _currentDatabase))
                {
                    PluginEntry.Log($"å‚æ•°æ›´æ–°æˆåŠŸ: {updatedParameter.Name}");
                }
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"å‚æ•°æ›´æ–°å¤±è´¥: {ex.Message}");
            }
        }
    }
}

===========================================
ğŸ“ 3. å®Œæ•´çš„BActionToolCommand.cså®ç°
=========================================

using System;
using System.Collections.Generic;
using System.Linq;
using ZwSoft.ZwCAD.ApplicationServices;
using ZwSoft.ZwCAD.DatabaseServices;
using ZwSoft.ZwCAD.EditorInput;
using ZwSoft.ZwCAD.Geometry;
using ZwSoft.ZwCAD.Runtime;
using ZwSoft.ZwCAD.Windows;
using ZWDynLookup.UI;
using ZWDynLookup.Models;
using ZWDynLookup.Service;

namespace ZWDynLookup.Commands
{
    /// <summary>
    /// BACTIONTOOLå‘½ä»¤ - åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ
    /// å®ç°Lé€‰é¡¹ï¼ˆæŸ¥å¯»åŠ¨ä½œï¼‰åŠŸèƒ½
    /// å¯¹åº”AutoCADçš„BACTIONTOOL Lå‘½ä»¤
    /// </summary>
    [CommandMethod("ZWBACTIONTOOL")]
    public class BActionToolCommand
    {
        private LookupActionCreator _actionCreator;
        private ActionSelectionManager _selectionManager;
        private SelectionSetManager _setManager;
        private LookupAction _currentAction;
        private string _actionName = "LookupAction";
        private string _actionDescription = "æŸ¥å¯»åŠ¨ä½œæè¿°";
        private ObjectId _selectedParameterId;
        private SelectionSet _selectedSelectionSet;
        private Document _currentDocument;
        private Database _currentDatabase;

        /// <summary>
        /// æ‰§è¡ŒBACTIONTOOLå‘½ä»¤
        /// </summary>
        public void Execute()
        {
            try
            {
                PluginEntry.Log("å¼€å§‹æ‰§è¡ŒZWBACTIONTOOLå‘½ä»¤");

                _currentDocument = PluginEntry.GetActiveDocument();
                if (_currentDocument == null)
                {
                    PluginEntry.ShowError("æ²¡æœ‰æ´»åŠ¨çš„CADæ–‡æ¡£");
                    return;
                }

                _currentDatabase = _currentDocument.Database;
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å—ç¼–è¾‘å™¨ä¸­
                if (!_currentDocument.Editor.IsInBlockEditor())
                {
                    PluginEntry.ShowWarning("è¯·åœ¨å—ç¼–è¾‘å™¨ä¸­ä½¿ç”¨æ­¤å‘½ä»¤");
                    return;
                }

                // åˆå§‹åŒ–ç®¡ç†å™¨
                InitializeManagers();

                // æ˜¾ç¤ºåŠ¨ä½œç±»å‹é€‰é¡¹
                ShowActionTypeOptions();
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"ZWBACTIONTOOLå‘½ä»¤æ‰§è¡Œå¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"å‘½ä»¤æ‰§è¡Œå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆå§‹åŒ–ç®¡ç†å™¨
        /// </summary>
        private void InitializeManagers()
        {
            _actionCreator = new LookupActionCreator();
            _selectionManager = new ActionSelectionManager();
            _setManager = new SelectionSetManager();
        }

        /// <summary>
        /// æ˜¾ç¤ºåŠ¨ä½œç±»å‹é€‰é¡¹
        /// </summary>
        private void ShowActionTypeOptions()
        {
            var editor = PluginEntry.GetEditor();
            if (editor == null) return;

            editor.WriteMessage("\n" + new string('=', 50));
            editor.WriteMessage("BACTIONTOOL - æŸ¥å¯»åŠ¨ä½œåˆ›å»º");
            editor.WriteMessage(new string('=', 50));
            editor.WriteMessage("åŠ¨ä½œç±»å‹: [é˜µåˆ—(A)/æŸ¥å¯»(L)/ç¿»è½¬(F)/ç§»åŠ¨(M)/æ—‹è½¬(R)/ç¼©æ”¾(S)/æ‹‰ä¼¸(T)/æè½´æ‹‰ä¼¸(P)]");
            editor.WriteMessage("é€‰æ‹©åŠ¨ä½œç±»å‹: ");

            var keywordOptions = new PromptKeywordOptions("\né€‰æ‹©åŠ¨ä½œç±»å‹ [æŸ¥å¯»(L)]: ");
            keywordOptions.Keywords.Add("A", "A", "é˜µåˆ—");
            keywordOptions.Keywords.Add("L", "L", "æŸ¥å¯»");
            keywordOptions.Keywords.Add("F", "F", "ç¿»è½¬");
            keywordOptions.Keywords.Add("M", "M", "ç§»åŠ¨");
            keywordOptions.Keywords.Add("R", "R", "æ—‹è½¬");
            keywordOptions.Keywords.Add("S", "S", "ç¼©æ”¾");
            keywordOptions.Keywords.Add("T", "T", "æ‹‰ä¼¸");
            keywordOptions.Keywords.Add("P", "P", "æè½´æ‹‰ä¼¸");
            keywordOptions.AllowNone = true;

            var result = editor.GetKeywords(keywordOptions);
            if (result.Status == PromptStatus.OK)
            {
                switch (result.StringResult.ToUpper())
                {
                    case "L":
                        // æŸ¥å¯»åŠ¨ä½œ - ä¸»è¦åŠŸèƒ½
                        CreateLookupAction();
                        break;
                    case "A":
                        CreateArrayAction();
                        break;
                    case "F":
                        CreateFlipAction();
                        break;
                    case "M":
                        CreateMoveAction();
                        break;
                    case "R":
                        CreateRotateAction();
                        break;
                    case "S":
                        CreateScaleAction();
                        break;
                    case "T":
                        CreateStretchAction();
                        break;
                    case "P":
                        CreatePolarStretchAction();
                        break;
                    default:
                        // é»˜è®¤é€‰æ‹©æŸ¥å¯»åŠ¨ä½œ
                        CreateLookupAction();
                        break;
                }
            }
            else if (result.Status == PromptStatus.None)
            {
                // é»˜è®¤é€‰æ‹©æŸ¥å¯»åŠ¨ä½œ
                CreateLookupAction();
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
            }
        }

        /// <summary>
        /// åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ
        /// </summary>
        private void CreateLookupAction()
        {
            try
            {
                var editor = PluginEntry.GetEditor();
                if (editor == null) return;

                editor.WriteMessage("\n=== åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ ===");

                // 1. é€‰æ‹©å‚æ•°
                SelectParameter();
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"åˆ›å»ºæŸ¥å¯»åŠ¨ä½œå¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"åˆ›å»ºæŸ¥å¯»åŠ¨ä½œå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// é€‰æ‹©å‚æ•°
        /// </summary>
        private void SelectParameter()
        {
            var editor = PluginEntry.GetEditor();
            if (editor == null) return;

            editor.WriteMessage("é€‰æ‹©æŸ¥å¯»å‚æ•°ç‚¹: ");
            var options = new PromptEntityOptions("é€‰æ‹©å‚æ•°ç‚¹æˆ–å¤¹ç‚¹: ");
            options.SetRejectMessage("è¯·é€‰æ‹©æœ‰æ•ˆçš„å‚æ•°ç‚¹");
            options.AddAllowedClass(typeof(BlockReference), false);

            var result = editor.GetEntity(options);
            if (result.Status == PromptStatus.OK)
            {
                // éªŒè¯é€‰æ‹©çš„å‚æ•°
                if (ValidateParameter(result.ObjectId))
                {
                    _selectedParameterId = result.ObjectId;
                    ProcessParameterSelection();
                }
                else
                {
                    editor.WriteMessage("\né”™è¯¯: é€‰æ‹©çš„å‚æ•°æ— æ•ˆ");
                    SelectParameter(); // é‡æ–°é€‰æ‹©
                }
            }
            else if (result.Status == PromptStatus.Cancel)
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
            }
            else
            {
                editor.WriteMessage("\né€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•");
                SelectParameter(); // é‡æ–°é€‰æ‹©
            }
        }

        /// <summary>
        /// éªŒè¯å‚æ•°
        /// </summary>
        private bool ValidateParameter(ObjectId parameterId)
        {
            try
            {
                if (parameterId.IsNull)
                    return false;

                using (Transaction tr = _currentDatabase.TransactionManager.StartTransaction())
                {
                    // è¿™é‡Œåº”è¯¥éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æŸ¥å¯»å‚æ•°
                    // ç”±äºä¸­æœ›CADçš„APIé™åˆ¶ï¼Œè¿™é‡ŒåšåŸºæœ¬éªŒè¯
                    BlockReference br = tr.GetObject(parameterId, OpenMode.ForRead) as BlockReference;
                    return br != null;
                }
            }
            catch
            {
                return false;
            }
        }

        /// <summary>
        /// å¤„ç†å‚æ•°é€‰æ‹©
        /// </summary>
        private void ProcessParameterSelection()
        {
            try
            {
                var editor = PluginEntry.GetEditor();
                if (editor == null) return;

                editor.WriteMessage("å‚æ•°é€‰æ‹©æˆåŠŸ");

                // 2. é€‰æ‹©åŠ¨ä½œé€‰æ‹©é›†
                SelectActionSet();
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"å¤„ç†å‚æ•°é€‰æ‹©å¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"å¤„ç†å‚æ•°é€‰æ‹©å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// é€‰æ‹©åŠ¨ä½œé€‰æ‹©é›†
        /// </summary>
        private void SelectActionSet()
        {
            var editor = PluginEntry.GetEditor();
            if (editor == null) return;

            editor.WriteMessage("\né€‰æ‹©åŠ¨ä½œé€‰æ‹©é›†:");
            editor.WriteMessage("é€‰é¡¹: [æ–°å»ºé€‰æ‹©é›†(N)/ä¸Šä¸€ä¸ªé€‰æ‹©é›†(P)/æ•´ä¸ªå›¾å½¢(W)/å‘½ä»¤è¡Œ(C)]");

            var keywordOptions = new PromptKeywordOptions("\né€‰æ‹©åŠ¨ä½œé€‰æ‹©é›† [æ–°å»ºé€‰æ‹©é›†(N)]: ");
            keywordOptions.Keywords.Add("N", "N", "æ–°å»ºé€‰æ‹©é›†");
            keywordOptions.Keywords.Add("P", "P", "ä¸Šä¸€ä¸ªé€‰æ‹©é›†");
            keywordOptions.Keywords.Add("W", "W", "æ•´ä¸ªå›¾å½¢");
            keywordOptions.Keywords.Add("C", "C", "å‘½ä»¤è¡Œ");
            keywordOptions.AllowNone = true;

            var result = editor.GetKeywords(keywordOptions);
            if (result.Status == PromptStatus.OK)
            {
                switch (result.StringResult.ToUpper())
                {
                    case "N":
                        CreateNewSelectionSet();
                        break;
                    case "P":
                        UseLastSelectionSet();
                        break;
                    case "W":
                        UseWholeDrawing();
                        break;
                    case "C":
                        UseCommandLineSelection();
                        break;
                    default:
                        CreateNewSelectionSet();
                        break;
                }
            }
            else if (result.Status == PromptStatus.None)
            {
                // é»˜è®¤æ–°å»ºé€‰æ‹©é›†
                CreateNewSelectionSet();
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
            }
        }

        /// <summary>
        /// åˆ›å»ºæ–°çš„é€‰æ‹©é›†
        /// </summary>
        private void CreateNewSelectionSet()
        {
            try
            {
                var editor = PluginEntry.GetEditor();
                if (editor == null) return;

                editor.WriteMessage("\né€‰æ‹©è¦åŒ…å«åœ¨åŠ¨ä½œé€‰æ‹©é›†ä¸­çš„å¯¹è±¡:");
                var selectionOptions = new PromptSelectionOptions();
                selectionOptions.MessageForAdding = "é€‰æ‹©å¯¹è±¡: ";
                selectionOptions.MessageForRemoval = "ç§»é™¤å¯¹è±¡: ";
                selectionOptions.AllowNone = true;

                var result = editor.GetSelection(selectionOptions);
                if (result.Status == PromptStatus.OK)
                {
                    _selectedSelectionSet = result.Value;
                    CreateLookupActionWithSelection();
                }
                else if (result.Status == PromptStatus.Cancel)
                {
                    editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
                }
                else
                {
                    editor.WriteMessage("\né€‰æ‹©é›†åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•");
                    SelectActionSet(); // é‡æ–°é€‰æ‹©
                }
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"åˆ›å»ºé€‰æ‹©é›†å¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"åˆ›å»ºé€‰æ‹©é›†å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// ä½¿ç”¨ä¸Šä¸€ä¸ªé€‰æ‹©é›†
        /// </summary>
        private void UseLastSelectionSet()
        {
            try
            {
                var lastSelection = _selectionManager.GetLastSelectionSet();
                if (lastSelection != null)
                {
                    _selectedSelectionSet = lastSelection;
                    CreateLookupActionWithSelection();
                }
                else
                {
                    var editor = PluginEntry.GetEditor();
                    editor?.WriteMessage("\nè­¦å‘Š: æ²¡æœ‰å¯ç”¨çš„ä¸Šä¸€ä¸ªé€‰æ‹©é›†");
                    CreateNewSelectionSet();
                }
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"ä½¿ç”¨ä¸Šä¸€ä¸ªé€‰æ‹©é›†å¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"ä½¿ç”¨ä¸Šä¸€ä¸ªé€‰æ‹©é›†å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// ä½¿ç”¨æ•´ä¸ªå›¾å½¢
        /// </summary>
        private void UseWholeDrawing()
        {
            try
            {
                var editor = PluginEntry.GetEditor();
                if (editor == null) return;

                // è·å–æ¨¡å‹ç©ºé—´ä¸­çš„æ‰€æœ‰å¯¹è±¡
                var selectionFilter = new SelectionFilter(new TypedValue[] { });
                var result = editor.SelectAll(selectionFilter);

                if (result.Status == PromptStatus.OK)
                {
                    _selectedSelectionSet = result.Value;
                    CreateLookupActionWithSelection();
                }
                else
                {
                    editor.WriteMessage("\né€‰æ‹©æ•´ä¸ªå›¾å½¢å¤±è´¥ï¼Œè¯·é‡è¯•");
                    SelectActionSet();
                }
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"é€‰æ‹©æ•´ä¸ªå›¾å½¢å¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"é€‰æ‹©æ•´ä¸ªå›¾å½¢å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// ä½¿ç”¨å‘½ä»¤è¡Œé€‰æ‹©
        /// </summary>
        private void UseCommandLineSelection()
        {
            var editor = PluginEntry.GetEditor();
            if (editor == null) return;

            editor.WriteMessage("\nè¾“å…¥é€‰æ‹©å¯¹è±¡: ");
            var options = new PromptStringOptions("å¯¹è±¡åç§°æˆ–é€‰æ‹©æ¨¡å¼: ");
            
            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                ProcessCommandLineInput(result.StringResult);
            }
            else
            {
                editor.WriteMessage("\næ“ä½œå·²å–æ¶ˆ");
            }
        }

        /// <summary>
        /// å¤„ç†å‘½ä»¤è¡Œè¾“å…¥
        /// </summary>
        private void ProcessCommandLineInput(string input)
        {
            try
            {
                var selectionSet = _selectionManager.CreateSelectionSetFromCommand(input, _currentDatabase);
                if (selectionSet != null)
                {
                    _selectedSelectionSet = selectionSet;
                    CreateLookupActionWithSelection();
                }
                else
                {
                    var editor = PluginEntry.GetEditor();
                    editor?.WriteMessage("\né”™è¯¯: æ— æ³•è§£æå‘½ä»¤è¡Œè¾“å…¥");
                    SelectActionSet();
                }
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"å¤„ç†å‘½ä»¤è¡Œè¾“å…¥å¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"å¤„ç†å‘½ä»¤è¡Œè¾“å…¥å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆ›å»ºå¸¦é€‰æ‹©é›†çš„æŸ¥å¯»åŠ¨ä½œ
        /// </summary>
        private void CreateLookupActionWithSelection()
        {
            try
            {
                var editor = PluginEntry.GetEditor();
                if (editor == null) return;

                editor.WriteMessage("\næ­£åœ¨åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ...");

                // è·å–åŠ¨ä½œåç§°
                GetActionName();
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"åˆ›å»ºæŸ¥å¯»åŠ¨ä½œå¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"åˆ›å»ºæŸ¥å¯»åŠ¨ä½œå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// è·å–åŠ¨ä½œåç§°
        /// </summary>
        private void GetActionName()
        {
            var editor = PluginEntry.GetEditor();
            if (editor == null) return;

            var options = new PromptStringOptions($"\nè¾“å…¥åŠ¨ä½œåç§° (å½“å‰: {_actionName}): ");
            options.AllowSpaces = true;
            options.DefaultValue = _actionName;

            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                if (!string.IsNullOrEmpty(result.StringResult))
                {
                    _actionName = result.StringResult;
                }
                GetActionDescription();
            }
            else
            {
                // ä½¿ç”¨é»˜è®¤å€¼
                _actionDescription = "";
                CreateLookupActionWithData();
            }
        }

        /// <summary>
        /// è·å–åŠ¨ä½œæè¿°
        /// </summary>
        private void GetActionDescription()
        {
            var editor = PluginEntry.GetEditor();
            if (editor == null) return;

            var options = new PromptStringOptions($"\nè¾“å…¥åŠ¨ä½œæè¿° (å½“å‰: {_actionDescription}): ");
            options.AllowSpaces = true;
            options.DefaultValue = _actionDescription;

            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                if (!string.IsNullOrEmpty(result.StringResult))
                {
                    _actionDescription = result.StringResult;
                }
                CreateLookupActionWithData();
            }
            else
            {
                // ä½¿ç”¨é»˜è®¤å€¼
                _actionDescription = "";
                CreateLookupActionWithData();
            }
        }

        /// <summary>
        /// åˆ›å»ºæŸ¥å¯»åŠ¨ä½œï¼ˆåŒ…å«æ•°æ®ï¼‰
        /// </summary>
        private void CreateLookupActionWithData()
        {
            try
            {
                var editor = PluginEntry.GetEditor();
                if (editor == null) return;

                // åˆ›å»ºæŸ¥å¯»åŠ¨ä½œå¯¹è±¡
                _currentAction = new LookupAction
                {
                    Name = _actionName,
                    Description = _actionDescription,
                    ParameterId = _selectedParameterId,
                    SelectionSet = _selectedSelectionSet,
                    ActionType = LookupActionType.TableLookup,
                    CreationTime = DateTime.Now,
                    IsEnabled = true
                };

                // åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ
                if (_actionCreator.CreateLookupAction(_currentAction, _currentDatabase))
                {
                    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    DisplayCreationSuccess(editor);

                    // æ‰“å¼€æŸ¥å¯»è¡¨é…ç½®å¯¹è¯æ¡†
                    OpenLookupTableDialog();
                }
                else
                {
                    editor.WriteMessage("\né”™è¯¯: æŸ¥å¯»åŠ¨ä½œåˆ›å»ºå¤±è´¥");
                    PluginEntry.Log($"æŸ¥å¯»åŠ¨ä½œåˆ›å»ºå¤±è´¥: {_actionName}");
                }
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"åˆ›å»ºæŸ¥å¯»åŠ¨ä½œå¼‚å¸¸: {ex.Message}");
                PluginEntry.ShowError($"åˆ›å»ºæŸ¥å¯»åŠ¨ä½œæ—¶å‘ç”Ÿå¼‚å¸¸: {ex.Message}");
            }
        }

        /// <summary>
        /// æ˜¾ç¤ºåˆ›å»ºæˆåŠŸä¿¡æ¯
        /// </summary>
        private void DisplayCreationSuccess(Editor editor)
        {
            editor.WriteMessage("\n" + new string('=', 50));
            editor.WriteMessage("æŸ¥å¯»åŠ¨ä½œåˆ›å»ºæˆåŠŸ");
            editor.WriteMessage(new string('=', 50));
            editor.WriteMessage($"åŠ¨ä½œåç§°: {_actionName}");
            editor.WriteLine($"åŠ¨ä½œæè¿°: {_actionDescription}");
            editor.WriteMessage($"å‚æ•°: {_selectedParameterId.ToString()}");
            editor.WriteMessage($"é€‰æ‹©é›†å¯¹è±¡æ•°: {_selectedSelectionSet?.Count ?? 0}");
            editor.WriteMessage(new string('=', 50));

            PluginEntry.Log($"æŸ¥å¯»åŠ¨ä½œåˆ›å»ºæˆåŠŸ: {_actionName}");
        }

        /// <summary>
        /// æ‰“å¼€æŸ¥å¯»è¡¨é…ç½®å¯¹è¯æ¡†
        /// </summary>
        private void OpenLookupTableDialog()
        {
            try
            {
                var dialog = new LookupTableDialog(_currentAction);
                
                // åœ¨CADçº¿ç¨‹ä¸­æ˜¾ç¤ºå¯¹è¯æ¡†
                Application.InvokeOnCadThread(() =>
                {
                    dialog.ShowDialog();

                    if (dialog.DialogResult == true)
                    {
                        var editor = PluginEntry.GetEditor();
                        editor?.WriteMessage("\næŸ¥å¯»è¡¨é…ç½®å®Œæˆ");
                    }
                });
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"æ‰“å¼€æŸ¥å¯»è¡¨å¯¹è¯æ¡†å¤±è´¥: {ex.Message}");
                PluginEntry.ShowWarning($"æ— æ³•æ‰“å¼€æŸ¥å¯»è¡¨å¯¹è¯æ¡†: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆ›å»ºå…¶ä»–ç±»å‹åŠ¨ä½œçš„ç®€åŒ–å®ç°
        /// </summary>
        private void CreateArrayAction()
        {
            var editor = PluginEntry.GetEditor();
            editor?.WriteMessage("\n=== åˆ›å»ºé˜µåˆ—åŠ¨ä½œ ===");
            editor?.WriteMessage("é˜µåˆ—åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreateFlipAction()
        {
            var editor = PluginEntry.GetEditor();
            editor?.WriteMessage("\n=== åˆ›å»ºç¿»è½¬åŠ¨ä½œ ===");
            editor?.WriteMessage("ç¿»è½¬åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreateMoveAction()
        {
            var editor = PluginEntry.GetEditor();
            editor?.WriteMessage("\n=== åˆ›å»ºç§»åŠ¨åŠ¨ä½œ ===");
            editor?.WriteMessage("ç§»åŠ¨åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreateRotateAction()
        {
            var editor = PluginEntry.GetEditor();
            editor?.WriteMessage("\n=== åˆ›å»ºæ—‹è½¬åŠ¨ä½œ ===");
            editor?.WriteMessage("æ—‹è½¬åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreateScaleAction()
        {
            var editor = PluginEntry.GetEditor();
            editor?.WriteMessage("\n=== åˆ›å»ºç¼©æ”¾åŠ¨ä½œ ===");
            editor?.WriteMessage("ç¼©æ”¾åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreateStretchAction()
        {
            var editor = PluginEntry.GetEditor();
            editor?.WriteMessage("\n=== åˆ›å»ºæ‹‰ä¼¸åŠ¨ä½œ ===");
            editor?.WriteMessage("æ‹‰ä¼¸åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreatePolarStretchAction()
        {
            var editor = PluginEntry.GetEditor();
            editor?.WriteMessage("\n=== åˆ›å»ºæè½´æ‹‰ä¼¸åŠ¨ä½œ ===");
            editor?.WriteMessage("æè½´æ‹‰ä¼¸åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }
    }
}

===========================================
ğŸ’¡ è¡¥å……è¯´æ˜
===========================================

è¿™ä»½è¡¥å……ä»£ç åŒ…å«äº†ï¼š

âœ… **å®Œæ•´çš„PluginEntry.cså®ç°**
- è¯¦ç»†çš„åˆå§‹åŒ–å’Œå¸è½½æµç¨‹
- äº‹ä»¶å¤„ç†å™¨æ³¨å†Œå’Œç®¡ç†
- UIé¢æ¿åˆ›å»ºå’Œç®¡ç†
- å®Œæ•´çš„æ—¥å¿—è®°å½•åŠŸèƒ½
- 7ä¸ªå‘½ä»¤çš„æ³¨å†Œå’Œç®¡ç†

âœ… **å®Œæ•´çš„BParameterCommand.cså®ç°**
- è¯¦ç»†çš„å‚æ•°åˆ›å»ºæµç¨‹
- å‚æ•°åç§°ã€æ ‡ç­¾ã€è¯´æ˜ã€å…³è”å‚æ•°è®¾ç½®
- å¤¹ç‚¹æ•°é€‰æ‹©ï¼ˆ0ä¸ªã€1ä¸ªã€æ‹¾å–ï¼‰
- å‚æ•°éªŒè¯å’Œé‡å¤æ£€æŸ¥
- é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
- å‚æ•°å±æ€§å¯¹è¯æ¡†é›†æˆ

âœ… **å®Œæ•´çš„BActionToolCommand.cså®ç°**
- å®Œæ•´çš„åŠ¨ä½œåˆ›å»ºæµç¨‹
- å‚æ•°é€‰æ‹©å’ŒéªŒè¯
- é€‰æ‹©é›†ç®¡ç†ï¼ˆæ–°å»ºã€ä¸Šä¸€ä¸ªã€æ•´ä¸ªå›¾å½¢ã€å‘½ä»¤è¡Œï¼‰
- åŠ¨ä½œåç§°å’Œæè¿°è®¾ç½®
- æŸ¥å¯»è¡¨é…ç½®å¯¹è¯æ¡†é›†æˆ
- 8ç§åŠ¨ä½œç±»å‹çš„æ”¯æŒï¼ˆæŸ¥å¯»ã€é˜µåˆ—ã€ç¿»è½¬ã€ç§»åŠ¨ã€æ—‹è½¬ã€ç¼©æ”¾ã€æ‹‰ä¼¸ã€æè½´æ‹‰ä¼¸ï¼‰

è¿™äº›ä»£ç æä¾›äº†å®Œæ•´çš„å®ç°ç»†èŠ‚ï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶åˆ°Visual Studioä¸­ä½¿ç”¨ã€‚æ‰€æœ‰åŠŸèƒ½éƒ½ä¸¥æ ¼æŒ‰ç…§æ‚¨æä¾›çš„æŸ¥å¯»åŠŸèƒ½ä½¿ç”¨æ­¥éª¤å®ç°ã€‚

ğŸ‰ ç°åœ¨æ‚¨æ‹¥æœ‰äº†å®Œæ•´ã€è¯¦ç»†ã€è¯¦ç»†å¯ç”¨çš„ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶ä»£ç ï¼