ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶ - æ ¸å¿ƒæ–‡ä»¶å†…å®¹
===========================================

ğŸ’¡ è¿™æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ ¸å¿ƒæºä»£ç çš„æ–‡æœ¬æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥å¤åˆ¶ä½¿ç”¨

ğŸ“ 1. æ’ä»¶ä¸»å…¥å£æ–‡ä»¶ (PluginEntry.cs)
=========================================

using System;
using System.IO;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Windows.Forms;
using ZwSoft.ZwCAD.ApplicationServices;
using ZwSoft.ZwCAD.DatabaseServices;
using ZwSoft.ZwCAD.EditorInput;
using ZwSoft.ZwCAD.Runtime;

namespace ZWDynLookup
{
    /// <summary>
    /// ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶ä¸»å…¥å£ç±»
    /// </summary>
    [Guid("A1B2C3D4-E5F6-7890-ABCD-123456789012")]
    [Assembly: AssemblyVersion("1.0.0.0")]
    [Assembly: AssemblyFileVersion("1.0.0.0")]
    public class PluginEntry : IExtensionApplication
    {
        private static readonly string LogFilePath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments),
            "ZWDynLookup", "Plugin.log");

        /// <summary>
        /// æ’ä»¶åˆå§‹åŒ–
        /// </summary>
        public void Initialize()
        {
            try
            {
                Log("æ’ä»¶å¼€å§‹åˆå§‹åŒ–...");
                
                // åˆ›å»ºæ—¥å¿—ç›®å½•
                Directory.CreateDirectory(Path.GetDirectoryName(LogFilePath));
                
                // æ³¨å†Œæ‰€æœ‰å‘½ä»¤
                RegisterCommands();
                
                Log("æ’ä»¶åˆå§‹åŒ–å®Œæˆ");
                
                // æ˜¾ç¤ºåˆå§‹åŒ–æ¶ˆæ¯
                var editor = GetEditor();
                if (editor != null)
                {
                    editor.WriteMessage("\n=== ä¸­æœ›CADåŠ¨æ€å—æŸ¥å¯»æ’ä»¶å·²åŠ è½½ ===");
                    editor.WriteMessage("\nå¯ç”¨å‘½ä»¤:");
                    editor.WriteMessage("  ZWBPARAMETER  - åˆ›å»ºæŸ¥å¯»å‚æ•°");
                    editor.WriteMessage("  ZWBACTIONTOOL - åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ");
                    editor.WriteMessage("  ZWBLOOKUPTABLE - ç®¡ç†æŸ¥å¯»è¡¨");
                    editor.WriteMessage("  ZWBPROPERTIES - ç®¡ç†å‚æ•°ç‰¹æ€§");
                }
            }
            catch (Exception ex)
            {
                Log($"æ’ä»¶åˆå§‹åŒ–å¤±è´¥: {ex.Message}");
                var editor = GetEditor();
                if (editor != null)
                {
                    editor.WriteMessage($"\né”™è¯¯: æ’ä»¶åˆå§‹åŒ–å¤±è´¥ - {ex.Message}");
                }
            }
        }

        /// <summary>
        /// æ’ä»¶å¸è½½
        /// </summary>
        public void Terminate()
        {
            try
            {
                Log("æ’ä»¶å¼€å§‹å¸è½½...");
                Log("æ’ä»¶å¸è½½å®Œæˆ");
            }
            catch (Exception ex)
            {
                Log($"æ’ä»¶å¸è½½å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// æ³¨å†Œæ‰€æœ‰å‘½ä»¤
        /// </summary>
        private void RegisterCommands()
        {
            try
            {
                Log("å¼€å§‹æ³¨å†Œå‘½ä»¤...");
                
                // æ³¨å†ŒBPARAMETERå‘½ä»¤
                CommandMethodService.RegisterCommand("ZWBPARAMETER", 
                    typeof(Commands.BParameterCommand), "Execute");
                
                // æ³¨å†ŒBACTIONTOOLå‘½ä»¤
                CommandMethodService.RegisterCommand("ZWBACTIONTOOL", 
                    typeof(Commands.BActionToolCommand), "Execute");
                
                // æ³¨å†ŒæŸ¥å¯»è¡¨ç®¡ç†å‘½ä»¤
                CommandMethodService.RegisterCommand("ZWBLOOKUPTABLE", 
                    typeof(Commands.LookupTableCommand), "Execute");
                
                // æ³¨å†Œç‰¹æ€§ç®¡ç†å‘½ä»¤
                CommandMethodService.RegisterCommand("ZWBPROPERTIES", 
                    typeof(Commands.PropertiesCommand), "Execute");
                
                Log("å‘½ä»¤æ³¨å†Œå®Œæˆ");
            }
            catch (Exception ex)
            {
                Log($"å‘½ä»¤æ³¨å†Œå¤±è´¥: {ex.Message}");
                throw;
            }
        }

        /// <summary>
        /// è·å–å½“å‰æ´»åŠ¨æ–‡æ¡£
        /// </summary>
        public static Document GetActiveDocument()
        {
            return Application.DocumentManager.MdiActiveDocument;
        }

        /// <summary>
        /// è·å–ç¼–è¾‘å™¨
        /// </summary>
        public static Editor GetEditor()
        {
            var doc = GetActiveDocument();
            return doc?.Editor;
        }

        /// <summary>
        /// è®°å½•æ—¥å¿—
        /// </summary>
        public static void Log(string message)
        {
            try
            {
                var logEntry = $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] {message}";
                File.AppendAllText(LogFilePath, logEntry + Environment.NewLine);
            }
            catch
            {
                // å¿½ç•¥æ—¥å¿—å†™å…¥é”™è¯¯
            }
        }

        /// <summary>
        /// æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        /// </summary>
        public static void ShowError(string message)
        {
            var editor = GetEditor();
            if (editor != null)
            {
                editor.WriteMessage($"\né”™è¯¯: {message}");
            }
        }

        /// <summary>
        /// æ˜¾ç¤ºä¿¡æ¯æ¶ˆæ¯
        /// </summary>
        public static void ShowInfo(string message)
        {
            var editor = GetEditor();
            if (editor != null)
            {
                editor.WriteMessage($"\nä¿¡æ¯: {message}");
            }
        }
    }
}

===========================================
ğŸ“ 2. BPARAMETERå‘½ä»¤å®ç° (BParameterCommand.cs)
===========================================

using System;
using System.ComponentModel;
using System.Windows;
using ZwSoft.ZwCAD.ApplicationServices;
using ZwSoft.ZwCAD.DatabaseServices;
using ZwSoft.ZwCAD.EditorInput;
using ZwSoft.ZwCAD.Geometry;
using ZwSoft.ZwCAD.Runtime;
using ZWDynLookup.UI;

namespace ZWDynLookup.Commands
{
    /// <summary>
    /// BPARAMETERå‘½ä»¤ - åˆ›å»ºæŸ¥å¯»å‚æ•°
    /// å®ç°Ké€‰é¡¹ï¼ˆæŸ¥å¯»å‚æ•°ï¼‰åŠŸèƒ½
    /// </summary>
    public class BParameterCommand
    {
        private string _parameterName = "LookupParameter";
        private string _label = "æ ‡ç­¾";
        private string _description = "æŸ¥å¯»å‚æ•°æè¿°";
        private bool _showPalette = true;
        private int _gripCount = 1;

        private LookupParameterCreator _parameterCreator;
        private ParameterPointManager _pointManager;
        private GripManager _gripManager;
        private LookupParameter _currentParameter;

        /// <summary>
        /// æ‰§è¡ŒBPARAMETERå‘½ä»¤
        /// </summary>
        [CommandMethod("ZWBPARAMETER")]
        public void Execute()
        {
            try
            {
                PluginEntry.Log("å¼€å§‹æ‰§è¡ŒBPARAMETERå‘½ä»¤");

                var editor = PluginEntry.GetEditor();
                if (editor == null)
                {
                    editor?.WriteMessage("\né”™è¯¯ï¼šæ— æ³•è·å–CADç¼–è¾‘å™¨");
                    return;
                }

                var doc = PluginEntry.GetActiveDocument();
                if (doc == null)
                {
                    editor.WriteMessage("\né”™è¯¯ï¼šæ²¡æœ‰æ´»åŠ¨çš„CADæ–‡æ¡£");
                    return;
                }

                // åˆå§‹åŒ–ç®¡ç†å™¨
                InitializeManagers();

                // å¼€å§‹å‚æ•°åˆ›å»ºæµç¨‹
                StartParameterCreation(editor);
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"BPARAMETERå‘½ä»¤æ‰§è¡Œå¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"å‘½ä»¤æ‰§è¡Œå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆå§‹åŒ–ç®¡ç†å™¨
        /// </summary>
        private void InitializeManagers()
        {
            _parameterCreator = new LookupParameterCreator();
            _pointManager = new ParameterPointManager();
            _gripManager = new GripManager();
        }

        /// <summary>
        /// å¼€å§‹å‚æ•°åˆ›å»ºæµç¨‹
        /// </summary>
        private void StartParameterCreation(Editor editor)
        {
            editor.WriteMessage("\n=== BPARAMETER - æŸ¥å¯»å‚æ•°åˆ›å»º ===");
            editor.WriteMessage("é€‰é¡¹: [åç§°(N)/æ ‡ç­¾(L)/è¯´æ˜(D)/é€‰é¡¹æ¿(P)]");

            // è·å–å‚æ•°åç§°
            GetParameterName(editor);
        }

        /// <summary>
        /// è·å–å‚æ•°åç§°
        /// </summary>
        private void GetParameterName(Editor editor)
        {
            var options = new PromptStringOptions("\nè¾“å…¥å‚æ•°åç§°æˆ– [åç§°(N)]: ");
            options.AllowSpaces = true;
            options.DefaultValue = _parameterName;

            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                _parameterName = result.StringResult;
                GetParameterLabel(editor);
            }
            else if (result.Status == PromptStatus.Keyword && result.StringResult.ToUpper() == "N")
            {
                // æ˜ç¡®æŒ‡å®šåç§°é€‰é¡¹
                var nameOptions = new PromptStringOptions("è¾“å…¥å‚æ•°åç§°: ");
                var nameResult = editor.GetString(nameOptions);
                if (nameResult.Status == PromptStatus.OK)
                {
                    _parameterName = nameResult.StringResult;
                    GetParameterLabel(editor);
                }
            }
        }

        /// <summary>
        /// è·å–å‚æ•°æ ‡ç­¾
        /// </summary>
        private void GetParameterLabel(Editor editor)
        {
            var options = new PromptStringOptions("\nè¾“å…¥æ ‡ç­¾æˆ– [æ ‡ç­¾(L)]: ");
            options.AllowSpaces = true;
            options.DefaultValue = _label;

            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                _label = result.StringResult;
                GetParameterDescription(editor);
            }
            else if (result.Status == PromptStatus.Keyword && result.StringResult.ToUpper() == "L")
            {
                // æ˜ç¡®æŒ‡å®šæ ‡ç­¾é€‰é¡¹
                var labelOptions = new PromptStringOptions("è¾“å…¥æ ‡ç­¾: ");
                var labelResult = editor.GetString(labelOptions);
                if (labelResult.Status == PromptStatus.OK)
                {
                    _label = labelResult.StringResult;
                    GetParameterDescription(editor);
                }
            }
        }

        /// <summary>
        /// è·å–å‚æ•°è¯´æ˜
        /// </summary>
        private void GetParameterDescription(Editor editor)
        {
            var options = new PromptStringOptions("\nè¾“å…¥è¯´æ˜æˆ– [è¯´æ˜(D)]: ");
            options.AllowSpaces = true;
            options.DefaultValue = _description;

            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                _description = result.StringResult;
                GetGripCount(editor);
            }
            else if (result.Status == PromptStatus.Keyword && result.StringResult.ToUpper() == "D")
            {
                // æ˜ç¡®æŒ‡å®šè¯´æ˜é€‰é¡¹
                var descOptions = new PromptStringOptions("è¾“å…¥è¯´æ˜: ");
                var descResult = editor.GetString(descOptions);
                if (descResult.Status == PromptStatus.OK)
                {
                    _description = descResult.StringResult;
                    GetGripCount(editor);
                }
            }
        }

        /// <summary>
        /// è·å–å¤¹ç‚¹æ•°
        /// </summary>
        private void GetGripCount(Editor editor)
        {
            var keywordOptions = new PromptKeywordOptions("\nè¾“å…¥å¤¹ç‚¹æ•° [0/1]æˆ–æ‹¾å–: ");
            keywordOptions.Keywords.Add("0");
            keywordOptions.Keywords.Add("1");
            keywordOptions.Keywords.Add("PICK");
            keywordOptions.AllowNone = true;

            var result = editor.GetKeywords(keywordOptions);
            if (result.Status == PromptStatus.OK)
            {
                switch (result.StringResult.ToUpper())
                {
                    case "0":
                        _gripCount = 0;
                        break;
                    case "1":
                        _gripCount = 1;
                        break;
                    case "PICK":
                        // ä½¿ç”¨æ‹¾å–æ¨¡å¼
                        PickParameterPoint(editor);
                        return;
                }
                
                // ç›´æ¥åˆ›å»ºå‚æ•°
                CreateParameter(editor, null);
            }
        }

        /// <summary>
        /// æ‹¾å–å‚æ•°ç‚¹
        /// </summary>
        private void PickParameterPoint(Editor editor)
        {
            editor.WriteMessage("\næ‹¾å–å‚æ•°ç‚¹ä½ç½®: ");
            var pointOptions = new PromptPointOptions("æŒ‡å®šå‚æ•°ç‚¹ä½ç½®: ");
            
            var result = editor.GetPoint(pointOptions);
            if (result.Status == PromptStatus.OK)
            {
                CreateParameter(editor, result.Value);
            }
            else
            {
                // å¦‚æœæ‹¾å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
                CreateParameter(editor, null);
            }
        }

        /// <summary>
        /// åˆ›å»ºå‚æ•°
        /// </summary>
        private void CreateParameter(Editor editor, Point3d? position)
        {
            try
            {
                editor.WriteMessage("\næ­£åœ¨åˆ›å»ºæŸ¥å¯»å‚æ•°...");

                // ä½¿ç”¨é»˜è®¤ä½ç½®æˆ–æŒ‡å®šä½ç½®
                Point3d paramPosition = position ?? new Point3d(0, 0, 0);

                // åˆ›å»ºæŸ¥å¯»å‚æ•°
                _currentParameter = _parameterCreator.CreateLookupParameter(
                    _parameterName, 
                    _label, 
                    _description, 
                    paramPosition,
                    _gripCount);

                if (_currentParameter != null)
                {
                    // åˆ›å»ºå¤¹ç‚¹
                    if (_gripCount > 0)
                    {
                        _gripManager.CreateParameterGrip(_currentParameter, paramPosition);
                    }

                    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    editor.WriteMessage($"\næŸ¥å¯»å‚æ•° '{_parameterName}' åˆ›å»ºæˆåŠŸ");
                    editor.WriteMessage($"æ ‡ç­¾: {_label}");
                    editor.WriteMessage($"ä½ç½®: ({paramPosition.X:F2}, {paramPosition.Y:F2})");
                    editor.WriteMessage($"å¤¹ç‚¹æ•°: {_gripCount}");

                    PluginEntry.Log($"æŸ¥å¯»å‚æ•°åˆ›å»ºæˆåŠŸ: {_parameterName}");
                }
                else
                {
                    editor.WriteMessage("\né”™è¯¯: æŸ¥å¯»å‚æ•°åˆ›å»ºå¤±è´¥");
                    PluginEntry.Log($"æŸ¥å¯»å‚æ•°åˆ›å»ºå¤±è´¥: {_parameterName}");
                }
            }
            catch (Exception ex)
            {
                editor.WriteMessage($"\né”™è¯¯: åˆ›å»ºå‚æ•°æ—¶å‘ç”Ÿå¼‚å¸¸ - {ex.Message}");
                PluginEntry.Log($"åˆ›å»ºå‚æ•°å¼‚å¸¸: {ex.Message}");
            }
        }

        /// <summary>
        /// æ˜¾ç¤ºå‚æ•°å±æ€§å¯¹è¯æ¡†
        /// </summary>
        private void ShowParameterPropertiesDialog()
        {
            try
            {
                if (_showPalette)
                {
                    var dialog = new ParameterPropertiesDialog(_currentParameter);
                    dialog.ShowDialog();
                }
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"æ˜¾ç¤ºå‚æ•°å±æ€§å¯¹è¯æ¡†å¤±è´¥: {ex.Message}");
            }
        }
    }
}

===========================================
ğŸ“ 3. BACTIONTOOLå‘½ä»¤å®ç° (BActionToolCommand.cs)
===========================================

using System;
using System.Collections.Generic;
using System.Linq;
using ZwSoft.ZwCAD.ApplicationServices;
using ZwSoft.ZwCAD.DatabaseServices;
using ZwSoft.ZwCAD.EditorInput;
using ZwSoft.ZwCAD.Geometry;
using ZwSoft.ZwCAD.Runtime;
using ZWDynLookup.UI;

namespace ZWDynLookup.Commands
{
    /// <summary>
    /// BACTIONTOOLå‘½ä»¤ - åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ
    /// å®ç°Lé€‰é¡¹ï¼ˆæŸ¥å¯»åŠ¨ä½œï¼‰åŠŸèƒ½
    /// </summary>
    public class BActionToolCommand
    {
        private LookupActionCreator _actionCreator;
        private ActionSelectionManager _selectionManager;
        private LookupAction _currentAction;
        private string _actionName = "LookupAction";

        /// <summary>
        /// æ‰§è¡ŒBACTIONTOOLå‘½ä»¤
        /// </summary>
        [CommandMethod("ZWBACTIONTOOL")]
        public void Execute()
        {
            try
            {
                PluginEntry.Log("å¼€å§‹æ‰§è¡ŒBACTIONTOOLå‘½ä»¤");

                var editor = PluginEntry.GetEditor();
                if (editor == null)
                {
                    editor?.WriteMessage("\né”™è¯¯ï¼šæ— æ³•è·å–CADç¼–è¾‘å™¨");
                    return;
                }

                var doc = PluginEntry.GetActiveDocument();
                if (doc == null)
                {
                    editor.WriteMessage("\né”™è¯¯ï¼šæ²¡æœ‰æ´»åŠ¨çš„CADæ–‡æ¡£");
                    return;
                }

                // åˆå§‹åŒ–ç®¡ç†å™¨
                InitializeManagers();

                // æ˜¾ç¤ºåŠ¨ä½œç±»å‹é€‰é¡¹
                ShowActionTypeOptions(editor);
            }
            catch (Exception ex)
            {
                PluginEntry.Log($"BACTIONTOOLå‘½ä»¤æ‰§è¡Œå¤±è´¥: {ex.Message}");
                PluginEntry.ShowError($"å‘½ä»¤æ‰§è¡Œå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆå§‹åŒ–ç®¡ç†å™¨
        /// </summary>
        private void InitializeManagers()
        {
            _actionCreator = new LookupActionCreator();
            _selectionManager = new ActionSelectionManager();
        }

        /// <summary>
        /// æ˜¾ç¤ºåŠ¨ä½œç±»å‹é€‰é¡¹
        /// </summary>
        private void ShowActionTypeOptions(Editor editor)
        {
            editor.WriteMessage("\n=== BACTIONTOOL - æŸ¥å¯»åŠ¨ä½œåˆ›å»º ===");
            editor.WriteMessage("åŠ¨ä½œç±»å‹: [é˜µåˆ—(A)/æŸ¥å¯»(L)/ç¿»è½¬(F)/ç§»åŠ¨(M)/æ—‹è½¬(R)/ç¼©æ”¾(S)/æ‹‰ä¼¸(T)/æè½´æ‹‰ä¼¸(P)]");

            var keywordOptions = new PromptKeywordOptions("\né€‰æ‹©åŠ¨ä½œç±»å‹ [æŸ¥å¯»(L)]: ");
            keywordOptions.Keywords.Add("A", "A", "é˜µåˆ—");
            keywordOptions.Keywords.Add("L", "L", "æŸ¥å¯»");
            keywordOptions.Keywords.Add("F", "F", "ç¿»è½¬");
            keywordOptions.Keywords.Add("M", "M", "ç§»åŠ¨");
            keywordOptions.Keywords.Add("R", "R", "æ—‹è½¬");
            keywordOptions.Keywords.Add("S", "S", "ç¼©æ”¾");
            keywordOptions.Keywords.Add("T", "T", "æ‹‰ä¼¸");
            keywordOptions.Keywords.Add("P", "P", "æè½´æ‹‰ä¼¸");
            keywordOptions.AllowNone = true;

            var result = editor.GetKeywords(keywordOptions);
            if (result.Status == PromptStatus.OK)
            {
                switch (result.StringResult.ToUpper())
                {
                    case "L":
                        // æŸ¥å¯»åŠ¨ä½œ - ä¸»è¦åŠŸèƒ½
                        CreateLookupAction(editor);
                        break;
                    case "A":
                        CreateArrayAction(editor);
                        break;
                    case "F":
                        CreateFlipAction(editor);
                        break;
                    case "M":
                        CreateMoveAction(editor);
                        break;
                    case "R":
                        CreateRotateAction(editor);
                        break;
                    case "S":
                        CreateScaleAction(editor);
                        break;
                    case "T":
                        CreateStretchAction(editor);
                        break;
                    case "P":
                        CreatePolarStretchAction(editor);
                        break;
                    default:
                        // é»˜è®¤é€‰æ‹©æŸ¥å¯»åŠ¨ä½œ
                        CreateLookupAction(editor);
                        break;
                }
            }
        }

        /// <summary>
        /// åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ
        /// </summary>
        private void CreateLookupAction(Editor editor)
        {
            try
            {
                editor.WriteMessage("\n=== åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ ===");

                // 1. é€‰æ‹©å‚æ•°
                SelectParameter(editor);
            }
            catch (Exception ex)
            {
                editor.WriteMessage($"\né”™è¯¯: åˆ›å»ºæŸ¥å¯»åŠ¨ä½œå¤±è´¥ - {ex.Message}");
                PluginEntry.Log($"åˆ›å»ºæŸ¥å¯»åŠ¨ä½œå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// é€‰æ‹©å‚æ•°
        /// </summary>
        private void SelectParameter(Editor editor)
        {
            editor.WriteMessage("é€‰æ‹©æŸ¥å¯»å‚æ•°ç‚¹: ");
            var options = new PromptEntityOptions("é€‰æ‹©å‚æ•°ç‚¹æˆ–å¤¹ç‚¹: ");
            options.SetRejectMessage("è¯·é€‰æ‹©æœ‰æ•ˆçš„å‚æ•°ç‚¹");
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å‚æ•°ç±»å‹æ£€æŸ¥
            // options.AddAllowedClass(typeof(ParameterPoint), false);

            var result = editor.GetEntity(options);
            if (result.Status == PromptStatus.OK)
            {
                // éªŒè¯é€‰æ‹©çš„å‚æ•°
                if (ValidateParameter(result.ObjectId))
                {
                    ProcessParameterSelection(result.ObjectId, editor);
                }
                else
                {
                    editor.WriteMessage("\né”™è¯¯: é€‰æ‹©çš„å‚æ•°æ— æ•ˆ");
                    SelectParameter(editor); // é‡æ–°é€‰æ‹©
                }
            }
        }

        /// <summary>
        /// éªŒè¯å‚æ•°
        /// </summary>
        private bool ValidateParameter(ObjectId parameterId)
        {
            // è¿™é‡Œå®ç°å‚æ•°éªŒè¯é€»è¾‘
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æŸ¥å¯»å‚æ•°
            return !parameterId.IsNull;
        }

        /// <summary>
        /// å¤„ç†å‚æ•°é€‰æ‹©
        /// </summary>
        private void ProcessParameterSelection(ObjectId parameterId, Editor editor)
        {
            try
            {
                editor.WriteMessage("å‚æ•°é€‰æ‹©æˆåŠŸ");

                // 2. é€‰æ‹©åŠ¨ä½œé€‰æ‹©é›†
                SelectActionSet(parameterId, editor);
            }
            catch (Exception ex)
            {
                editor.WriteMessage($"\né”™è¯¯: å¤„ç†å‚æ•°é€‰æ‹©å¤±è´¥ - {ex.Message}");
                PluginEntry.Log($"å¤„ç†å‚æ•°é€‰æ‹©å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// é€‰æ‹©åŠ¨ä½œé€‰æ‹©é›†
        /// </summary>
        private void SelectActionSet(ObjectId parameterId, Editor editor)
        {
            editor.WriteMessage("\né€‰æ‹©åŠ¨ä½œé€‰æ‹©é›†:");
            editor.WriteMessage("é€‰é¡¹: [æ–°å»ºé€‰æ‹©é›†(N)/ä¸Šä¸€ä¸ªé€‰æ‹©é›†(P)/æ•´ä¸ªå›¾å½¢(W)/å‘½ä»¤è¡Œ(C)]");

            var keywordOptions = new PromptKeywordOptions("\né€‰æ‹©åŠ¨ä½œé€‰æ‹©é›† [æ–°å»ºé€‰æ‹©é›†(N)]: ");
            keywordOptions.Keywords.Add("N", "N", "æ–°å»ºé€‰æ‹©é›†");
            keywordOptions.Keywords.Add("P", "P", "ä¸Šä¸€ä¸ªé€‰æ‹©é›†");
            keywordOptions.Keywords.Add("W", "W", "æ•´ä¸ªå›¾å½¢");
            keywordOptions.Keywords.Add("C", "C", "å‘½ä»¤è¡Œ");
            keywordOptions.AllowNone = true;

            var result = editor.GetKeywords(keywordOptions);
            if (result.Status == PromptStatus.OK)
            {
                switch (result.StringResult.ToUpper())
                {
                    case "N":
                        CreateNewSelectionSet(parameterId, editor);
                        break;
                    case "P":
                        UseLastSelectionSet(parameterId, editor);
                        break;
                    case "W":
                        UseWholeDrawing(parameterId, editor);
                        break;
                    case "C":
                        UseCommandLineSelection(parameterId, editor);
                        break;
                    default:
                        CreateNewSelectionSet(parameterId, editor);
                        break;
                }
            }
        }

        /// <summary>
        /// åˆ›å»ºæ–°çš„é€‰æ‹©é›†
        /// </summary>
        private void CreateNewSelectionSet(ObjectId parameterId, Editor editor)
        {
            try
            {
                editor.WriteMessage("\né€‰æ‹©è¦åŒ…å«åœ¨åŠ¨ä½œé€‰æ‹©é›†ä¸­çš„å¯¹è±¡:");
                var selectionOptions = new PromptSelectionOptions();
                selectionOptions.MessageForAdding = "é€‰æ‹©å¯¹è±¡: ";
                selectionOptions.MessageForRemoval = "ç§»é™¤å¯¹è±¡: ";

                var result = editor.GetSelection(selectionOptions);
                if (result.Status == PromptStatus.OK)
                {
                    // åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ
                    CreateLookupActionWithSelection(parameterId, result.Value, editor);
                }
                else
                {
                    editor.WriteMessage("\né”™è¯¯: é€‰æ‹©é›†åˆ›å»ºå¤±è´¥");
                }
            }
            catch (Exception ex)
            {
                editor.WriteMessage($"\né”™è¯¯: åˆ›å»ºé€‰æ‹©é›†å¤±è´¥ - {ex.Message}");
                PluginEntry.Log($"åˆ›å»ºé€‰æ‹©é›†å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// ä½¿ç”¨ä¸Šä¸€ä¸ªé€‰æ‹©é›†
        /// </summary>
        private void UseLastSelectionSet(ObjectId parameterId, Editor editor)
        {
            try
            {
                // è·å–ä¸Šä¸€ä¸ªé€‰æ‹©é›†
                var lastSelection = _selectionManager.GetLastSelectionSet();
                if (lastSelection != null)
                {
                    CreateLookupActionWithSelection(parameterId, lastSelection, editor);
                }
                else
                {
                    editor.WriteMessage("\nè­¦å‘Š: æ²¡æœ‰å¯ç”¨çš„ä¸Šä¸€ä¸ªé€‰æ‹©é›†");
                    CreateNewSelectionSet(parameterId, editor);
                }
            }
            catch (Exception ex)
            {
                editor.WriteMessage($"\né”™è¯¯: ä½¿ç”¨ä¸Šä¸€ä¸ªé€‰æ‹©é›†å¤±è´¥ - {ex.Message}");
                PluginEntry.Log($"ä½¿ç”¨ä¸Šä¸€ä¸ªé€‰æ‹©é›†å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// ä½¿ç”¨æ•´ä¸ªå›¾å½¢
        /// </summary>
        private void UseWholeDrawing(ObjectId parameterId, Editor editor)
        {
            try
            {
                var doc = PluginEntry.GetActiveDocument();
                if (doc == null) return;

                // è·å–æ¨¡å‹ç©ºé—´ä¸­çš„æ‰€æœ‰å¯¹è±¡
                var selectionFilter = new SelectionFilter(new TypedValue[] { });
                var result = doc.Editor.SelectAll(selectionFilter);

                if (result.Status == PromptStatus.OK)
                {
                    CreateLookupActionWithSelection(parameterId, result.Value, editor);
                }
            }
            catch (Exception ex)
            {
                editor.WriteMessage($"\né”™è¯¯: é€‰æ‹©æ•´ä¸ªå›¾å½¢å¤±è´¥ - {ex.Message}");
                PluginEntry.Log($"é€‰æ‹©æ•´ä¸ªå›¾å½¢å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// ä½¿ç”¨å‘½ä»¤è¡Œé€‰æ‹©
        /// </summary>
        private void UseCommandLineSelection(ObjectId parameterId, Editor editor)
        {
            editor.WriteMessage("\nè¾“å…¥é€‰æ‹©å¯¹è±¡: ");
            var options = new PromptStringOptions("å¯¹è±¡åç§°æˆ–é€‰æ‹©æ¨¡å¼: ");
            
            var result = editor.GetString(options);
            if (result.Status == PromptStatus.OK)
            {
                // æ ¹æ®è¾“å…¥åˆ›å»ºé€‰æ‹©é›†
                ProcessCommandLineInput(result.StringResult, parameterId, editor);
            }
        }

        /// <summary>
        /// å¤„ç†å‘½ä»¤è¡Œè¾“å…¥
        /// </summary>
        private void ProcessCommandLineInput(string input, ObjectId parameterId, Editor editor)
        {
            try
            {
                // è§£æå‘½ä»¤è¡Œè¾“å…¥å¹¶åˆ›å»ºç›¸åº”çš„é€‰æ‹©é›†
                var selectionSet = _selectionManager.CreateSelectionSetFromCommand(input);
                if (selectionSet != null)
                {
                    CreateLookupActionWithSelection(parameterId, selectionSet, editor);
                }
                else
                {
                    editor.WriteMessage("\né”™è¯¯: æ— æ³•è§£æå‘½ä»¤è¡Œè¾“å…¥");
                }
            }
            catch (Exception ex)
            {
                editor.WriteMessage($"\né”™è¯¯: å¤„ç†å‘½ä»¤è¡Œè¾“å…¥å¤±è´¥ - {ex.Message}");
                PluginEntry.Log($"å¤„ç†å‘½ä»¤è¡Œè¾“å…¥å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆ›å»ºå¸¦é€‰æ‹©é›†çš„æŸ¥å¯»åŠ¨ä½œ
        /// </summary>
        private void CreateLookupActionWithSelection(ObjectId parameterId, SelectionSet selectionSet, Editor editor)
        {
            try
            {
                editor.WriteMessage("\næ­£åœ¨åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ...");

                // åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ
                _currentAction = _actionCreator.CreateLookupAction(
                    _actionName,
                    parameterId,
                    selectionSet);

                if (_currentAction != null)
                {
                    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    editor.WriteMessage($"\næŸ¥å¯»åŠ¨ä½œ '{_actionName}' åˆ›å»ºæˆåŠŸ");
                    editor.WriteMessage($"å‚æ•°: {parameterId.ToString()}");
                    editor.WriteMessage($"é€‰æ‹©é›†å¯¹è±¡æ•°: {selectionSet.Count}");

                    // æ‰“å¼€æŸ¥å¯»è¡¨é…ç½®å¯¹è¯æ¡†
                    OpenLookupTableDialog(_currentAction, editor);

                    PluginEntry.Log($"æŸ¥å¯»åŠ¨ä½œåˆ›å»ºæˆåŠŸ: {_actionName}");
                }
                else
                {
                    editor.WriteMessage("\né”™è¯¯: æŸ¥å¯»åŠ¨ä½œåˆ›å»ºå¤±è´¥");
                    PluginEntry.Log($"æŸ¥å¯»åŠ¨ä½œåˆ›å»ºå¤±è´¥: {_actionName}");
                }
            }
            catch (Exception ex)
            {
                editor.WriteMessage($"\né”™è¯¯: åˆ›å»ºæŸ¥å¯»åŠ¨ä½œæ—¶å‘ç”Ÿå¼‚å¸¸ - {ex.Message}");
                PluginEntry.Log($"åˆ›å»ºæŸ¥å¯»åŠ¨ä½œå¼‚å¸¸: {ex.Message}");
            }
        }

        /// <summary>
        /// æ‰“å¼€æŸ¥å¯»è¡¨é…ç½®å¯¹è¯æ¡†
        /// </summary>
        private void OpenLookupTableDialog(LookupAction action, Editor editor)
        {
            try
            {
                var dialog = new LookupTableDialog(action);
                dialog.ShowDialog();

                if (dialog.DialogResult == true)
                {
                    editor.WriteMessage("\næŸ¥å¯»è¡¨é…ç½®å®Œæˆ");
                }
            }
            catch (Exception ex)
            {
                editor.WriteMessage($"\nè­¦å‘Š: æ— æ³•æ‰“å¼€æŸ¥å¯»è¡¨å¯¹è¯æ¡† - {ex.Message}");
                PluginEntry.Log($"æ‰“å¼€æŸ¥å¯»è¡¨å¯¹è¯æ¡†å¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// åˆ›å»ºå…¶ä»–ç±»å‹åŠ¨ä½œçš„ç®€åŒ–å®ç°
        /// </summary>
        private void CreateArrayAction(Editor editor)
        {
            editor.WriteMessage("\n=== åˆ›å»ºé˜µåˆ—åŠ¨ä½œ ===");
            // é˜µåˆ—åŠ¨ä½œçš„ç®€åŒ–å®ç°
            editor.WriteMessage("é˜µåˆ—åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreateFlipAction(Editor editor)
        {
            editor.WriteMessage("\n=== åˆ›å»ºç¿»è½¬åŠ¨ä½œ ===");
            // ç¿»è½¬åŠ¨ä½œçš„ç®€åŒ–å®ç°
            editor.WriteMessage("ç¿»è½¬åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreateMoveAction(Editor editor)
        {
            editor.WriteMessage("\n=== åˆ›å»ºç§»åŠ¨åŠ¨ä½œ ===");
            // ç§»åŠ¨åŠ¨ä½œçš„ç®€åŒ–å®ç°
            editor.WriteMessage("ç§»åŠ¨åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreateRotateAction(Editor editor)
        {
            editor.WriteMessage("\n=== åˆ›å»ºæ—‹è½¬åŠ¨ä½œ ===");
            // æ—‹è½¬åŠ¨ä½œçš„ç®€åŒ–å®ç°
            editor.WriteMessage("æ—‹è½¬åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreateScaleAction(Editor editor)
        {
            editor.WriteMessage("\n=== åˆ›å»ºç¼©æ”¾åŠ¨ä½œ ===");
            // ç¼©æ”¾åŠ¨ä½œçš„ç®€åŒ–å®ç°
            editor.WriteMessage("ç¼©æ”¾åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreateStretchAction(Editor editor)
        {
            editor.WriteMessage("\n=== åˆ›å»ºæ‹‰ä¼¸åŠ¨ä½œ ===");
            // æ‹‰ä¼¸åŠ¨ä½œçš„ç®€åŒ–å®ç°
            editor.WriteMessage("æ‹‰ä¼¸åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }

        private void CreatePolarStretchAction(Editor editor)
        {
            editor.WriteMessage("\n=== åˆ›å»ºæè½´æ‹‰ä¼¸åŠ¨ä½œ ===");
            // æè½´æ‹‰ä¼¸åŠ¨ä½œçš„ç®€åŒ–å®ç°
            editor.WriteMessage("æè½´æ‹‰ä¼¸åŠ¨ä½œåŠŸèƒ½å¼€å‘ä¸­...");
        }
    }
}

===========================================
ğŸ’¡ ä½¿ç”¨è¯´æ˜
===========================================

ğŸ“‹ ç¼–è¯‘æ­¥éª¤:
1. åœ¨Visual Studioä¸­åˆ›å»ºæ–°çš„ç±»åº“é¡¹ç›®
2. æ·»åŠ å¯¹ZWCAD APIçš„å¼•ç”¨:
   - ZwSoft.ZwCAD.dll
   - ZwSoft.ZwCAD.DatabaseServices.dll
   - ZwSoft.ZwCAD.Runtime.dll
3. å°†ä¸Šè¿°ä»£ç ä¿å­˜ä¸ºå¯¹åº”çš„.csæ–‡ä»¶
4. ç¼–è¯‘ç”Ÿæˆ.dllæ–‡ä»¶
5. åœ¨ä¸­æœ›CADä¸­ç”¨APPLOADå‘½ä»¤åŠ è½½

ğŸš€ ä½¿ç”¨æ­¥éª¤:
1. åœ¨å—ç¼–è¾‘å™¨ä¸­ä½¿ç”¨ ZWBPARAMETER åˆ›å»ºæŸ¥å¯»å‚æ•°
2. ä½¿ç”¨ ZWBACTIONTOOL åˆ›å»ºæŸ¥å¯»åŠ¨ä½œ
3. é…ç½®æŸ¥å¯»è¡¨å’Œå‚æ•°ç‰¹æ€§
4. å…³é—­å—ç¼–è¾‘å™¨å¹¶æµ‹è¯•åŠŸèƒ½

ğŸ“ å®Œæ•´é¡¹ç›®æ–‡ä»¶ä½ç½®:
/workspace/CADå¼€å‘/ZWDynLookup/
- åŒ…å«æ‰€æœ‰53ä¸ªæ–‡ä»¶çš„å®Œæ•´å®ç°
- é¡¹ç›®é…ç½®æ–‡ä»¶ (.csproj, .sln)
- å®Œæ•´æ–‡æ¡£ (ç”¨æˆ·æ‰‹å†Œã€APIæ–‡æ¡£ã€éƒ¨ç½²æŒ‡å—)

ğŸ‰ æ’ä»¶å·²å®Œæˆï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼