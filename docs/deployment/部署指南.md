---
AIGC:
    ContentProducer: Minimax Agent AI
    ContentPropagator: Minimax Agent AI
    Label: AIGC
    ProduceID: "00000000000000000000000000000000"
    PropagateID: "00000000000000000000000000000000"
    ReservedCode1: 304602210096e242491a1e2331b07dc7c5b5361795e6d880b930b67516c5a1678ea24930c1022100feec705ede736bc42da623cca380664594bc79e14cea2003582d410ae2e5a4e4
    ReservedCode2: 3045022030445c2b79462b7dd772662bdbfdb932c6553be5893f51dfbab8cda8e92b6249022100da9da9b7c3e7fb9891d59829d67d4c473fb33d8ad8c8c10c0a77a40c77870cb1
---

# 中望CAD动态块查寻插件部署指南

## 目录
1. [部署概述](#部署概述)
2. [环境准备](#环境准备)
3. [安装部署](#安装部署)
4. [配置设置](#配置设置)
5. [企业级部署](#企业级部署)
6. [卸载回滚](#卸载回滚)
7. [监控维护](#监控维护)

---

## 部署概述

### 部署模式
- **单机部署**：适用于个人用户或小型团队
- **网络部署**：适用于企业环境，多用户共享
- **集中管理部署**：适用于大型企业，统一配置管理

### 部署架构
```
企业网络架构
├── 文件服务器 (插件安装包存储)
├── 配置服务器 (集中配置管理)
├── 更新服务器 (版本更新分发)
└── 客户端工作站
    ├── 中望CAD安装
    └── 插件客户端
```

### 部署流程
1. 环境评估和准备
2. 插件安装包准备
3. 自动化安装脚本部署
4. 配置同步和验证
5. 用户培训和上线

---

## 环境准备

### 服务器环境要求

**文件服务器配置：**
- 操作系统：Windows Server 2019 或更高版本
- 存储空间：至少 10GB 可用空间
- 网络带宽：100Mbps 或更高
- 冗余：RAID 1 或更高

**配置服务器配置：**
- 操作系统：Windows Server 2019 或更高版本
- 数据库：SQL Server 2017 或更高版本 / MySQL 8.0+
- 内存：8GB RAM 或更高
- CPU：4核心或更高

### 客户端环境要求

**最低配置：**
- 操作系统：Windows 10 (64位) 版本 1809 或更高
- 中望CAD：2020 版本或更高
- .NET Framework：4.8
- 内存：4GB RAM
- 硬盘空间：1GB 可用空间
- 网络：10Mbps 带宽

**推荐配置：**
- 操作系统：Windows 11 (64位)
- 中望CAD：2024 版本或更高
- .NET Framework：4.8
- 内存：8GB RAM 或更高
- 硬盘空间：2GB 可用空间
- 网络：100Mbps 带宽

**企业级配置：**
- 操作系统：Windows 11 Enterprise
- 中望CAD：2024 Enterprise 版本
- .NET Framework：4.8
- 内存：16GB RAM 或更高
- SSD 硬盘：5GB 可用空间
- 网络：1Gbps 带宽

### 网络环境要求

**防火墙配置：**
- 允许插件相关端口通信
- 配置文件下载端口
- 更新服务通信端口

**代理服务器配置：**
- 支持 HTTP/HTTPS 代理
- 配置代理白名单
- 设置代理认证

---

## 安装部署

### 单机部署

#### 自动安装（推荐）
```powershell
# PowerShell 脚本 - AutoInstall.ps1
param(
    [string]$InstallPath = "C:\Program Files\ZWDynLookup",
    [string]$ConfigPath = "$env:USERPROFILE\Documents\ZWDynLookup",
    [switch]$Silent = $false
)

# 检查管理员权限
if (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator"))
{
    Write-Error "需要管理员权限运行此脚本"
    exit 1
}

# 检查中望CAD安装
$zwcadPath = Get-ItemProperty "HKLM:\SOFTWARE\WOW6432Node\Autodesk\AutoCAD\R24.0" -Name "AcadLocation" -ErrorAction SilentlyContinue
if (-not $zwcadPath) {
    Write-Error "未检测到中望CAD安装"
    exit 1
}

# 创建安装目录
if (!(Test-Path $InstallPath)) {
    New-Item -ItemType Directory -Path $InstallPath -Force
}

# 复制插件文件
Copy-Item ".\ZWDynLookup\*" $InstallPath -Recurse -Force

# 注册插件
$regPath = "HKLM:\SOFTWARE\WOW6432Node\ZWDynLookup"
if (!(Test-Path $regPath)) {
    New-Item -Path $regPath -Force
}

Set-ItemProperty $regPath "InstallPath" $InstallPath
Set-ItemProperty $regPath "InstallDate" (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
Set-ItemProperty $regPath "Version" "1.0.0"

# 创建配置目录
if (!(Test-Path $ConfigPath)) {
    New-Item -ItemType Directory -Path $ConfigPath -Force
}

# 初始化配置文件
$configFile = Join-Path $ConfigPath "config.xml"
$configContent = @"
<?xml version="1.0" encoding="utf-8"?>
<Configuration>
  <General>
    <InstallPath>$InstallPath</InstallPath>
    <ConfigPath>$ConfigPath</ConfigPath>
    <LogLevel>Info</LogLevel>
    <Language>zh-CN</Language>
    <AutoSave>true</AutoSave>
  </General>
  <UI>
    <Theme>Light</Theme>
    <ShowTooltips>true</ShowTooltips>
    <ConfirmActions>true</ConfirmActions>
  </UI>
  <Performance>
    <MaxParameters>50</MaxParameters>
    <MaxSelectionSets>20</MaxSelectionSets>
  </Performance>
</Configuration>
"@
$configContent | Out-File $configFile -Encoding UTF8

Write-Host "插件安装完成！" -ForegroundColor Green
Write-Host "安装路径: $InstallPath" -ForegroundColor Cyan
Write-Host "配置路径: $ConfigPath" -ForegroundColor Cyan
```

#### 静默安装
```batch
:: 静默安装脚本 - SilentInstall.bat
@echo off
echo 正在安装中望CAD动态块查寻插件...

:: 检查管理员权限
net session >nul 2>&1
if %errorlevel% neq 0 (
    echo 错误: 需要管理员权限运行此脚本
    pause
    exit /b 1
)

:: 启动安装程序
ZWDynLookup_Setup.exe /S /V/qn /V ADDLOCAL=ALL /V INSTALLDIR="C:\Program Files\ZWDynLookup"

:: 检查安装结果
if %errorlevel% equ 0 (
    echo 安装成功完成
) else (
    echo 安装失败，错误代码: %errorlevel%
    pause
    exit /b 1
)

echo 插件安装完成，请重启中望CAD
pause
```

### 网络部署

#### 网络安装服务器配置

**创建网络共享：**
```powershell
# NetworkSetup.ps1
# 创建网络安装共享

# 创建安装目录
$installShare = "C:\InstallShares\ZWDynLookup"
New-Item -ItemType Directory -Path $installShare -Force

# 复制安装文件
Copy-Item ".\Release\*" $installShare -Recurse -Force

# 创建网络共享
$shareName = "ZWDynLookupInstall"
net share $shareName=$installShare "/GRANT:Everyone,FULL"

# 设置共享权限
icacls $installShare /grant "Everyone:(OI)(CI)F" /T

# 创建自动安装脚本
$autoInstallScript = @"
@echo off
net use * /delete /yes
net use Z: \\%COMPUTERNAME%\$shareName
Z:\AutoInstall.bat
net use Z: /delete
"@
$autoInstallScript | Out-File "$installShare\NetworkInstall.bat" -Encoding ASCII

Write-Host "网络安装服务器配置完成" -ForegroundColor Green
Write-Host "共享路径: \\$env:COMPUTERNAME\$shareName" -ForegroundColor Cyan
```

#### 客户端网络安装
```batch
:: 客户端网络安装脚本 - ClientInstall.bat
@echo off
echo 正在从网络安装中望CAD动态块查寻插件...

:: 映射网络驱动器
net use Z: \\ServerName\ZWDynLookupInstall

:: 检查网络连接
if %errorlevel% neq 0 (
    echo 错误: 无法连接到安装服务器
    echo 请检查网络连接和共享权限
    pause
    exit /b 1
)

:: 启动网络安装
Z:\AutoInstall.bat

:: 取消网络驱动器映射
net use Z: /delete

echo 网络安装完成
pause
```

#### 分布式部署脚本
```powershell
# DistributedDeployment.ps1
# 分布式部署脚本

param(
    [Parameter(Mandatory=$true)]
    [string[]]$ComputerList,
    
    [Parameter(Mandatory=$true)]
    [string]$InstallServer,
    
    [string]$InstallShare = "ZWDynLookupInstall"
)

# 检查远程计算机连接
function Test-ComputerConnection {
    param([string]$ComputerName)
    
    try {
        $ping = New-Object System.Net.NetworkInformation.Ping
        $result = $ping.Send($ComputerName, 3000)
        return $result.Status -eq "Success"
    }
    catch {
        return $false
    }
}

# 远程安装函数
function Install-RemotePlugin {
    param([string]$ComputerName)
    
    Write-Host "正在在 $ComputerName 上安装插件..." -ForegroundColor Yellow
    
    # 映射网络驱动器
    $netUse = Invoke-Command -ComputerName $ComputerName -ScriptBlock {
        param($InstallServer, $InstallShare)
        net use Z: \\$InstallServer\$InstallShare
    } -ArgumentList $InstallServer, $InstallShare
    
    if ($netUse.ExitCode -eq 0) {
        # 执行安装
        $installResult = Invoke-Command -ComputerName $ComputerName -ScriptBlock {
            param($InstallServer, $InstallShare)
            
            # 检查管理员权限
            $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
            $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
            if (-not $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
                return @{ Success = $false; Error = "需要管理员权限" }
            }
            
            # 执行安装
            $process = Start-Process -FilePath "Z:\ZWDynLookup_Setup.exe" -ArgumentList "/S /V/qn" -Wait -PassThru
            return @{ Success = ($process.ExitCode -eq 0); ExitCode = $process.ExitCode }
        } -ArgumentList $InstallServer, $InstallShare
        
        # 清理网络驱动器
        Invoke-Command -ComputerName $ComputerName -ScriptBlock {
            net use Z: /delete
        }
        
        return $installResult
    }
    else {
        return @{ Success = $false; Error = "网络连接失败" }
    }
}

# 主部署流程
$successCount = 0
$failCount = 0

foreach ($computer in $ComputerList) {
    Write-Host "处理计算机: $computer" -ForegroundColor Cyan
    
    # 测试连接
    if (Test-ComputerConnection -ComputerName $computer) {
        $result = Install-RemotePlugin -ComputerName $computer
        
        if ($result.Success) {
            Write-Host "✓ $computer 安装成功" -ForegroundColor Green
            $successCount++
        }
        else {
            Write-Host "✗ $computer 安装失败: $($result.Error)" -ForegroundColor Red
            $failCount++
        }
    }
    else {
        Write-Host "✗ $computer 连接失败" -ForegroundColor Red
        $failCount++
    }
}

# 生成部署报告
Write-Host "`n部署完成!" -ForegroundColor Cyan
Write-Host "成功: $successCount 台计算机" -ForegroundColor Green
Write-Host "失败: $failCount 台计算机" -ForegroundColor Red
```

---

## 配置设置

### 配置文件结构

**主配置文件 (config.xml):**
```xml
<?xml version="1.0" encoding="utf-8"?>
<Configuration>
  <General>
    <InstallPath>C:\Program Files\ZWDynLookup</InstallPath>
    <ConfigPath>%USERPROFILE%\Documents\ZWDynLookup</ConfigPath>
    <LogLevel>Info</LogLevel>
    <Language>zh-CN</Language>
    <AutoSave>true</AutoSave>
    <AutoUpdate>true</AutoUpdate>
    <UpdateServer>https://updates.zwdynlookup.com</UpdateServer>
  </General>
  
  <UI>
    <Theme>Light</Theme>
    <ShowTooltips>true</ShowTooltips>
    <ConfirmActions>true</ConfirmActions>
    <ShowAdvancedOptions>false</ShowAdvancedOptions>
    <WindowPlacement>
      <X>100</X>
      <Y>100</Y>
      <Width>800</Width>
      <Height>600</Height>
    </WindowPlacement>
  </UI>
  
  <Performance>
    <MaxParameters>50</MaxParameters>
    <MaxSelectionSets>20</MaxSelectionSets>
    <MaxUndoLevels>100</MaxUndoLevels>
    <EnableCaching>true</EnableCaching>
    <CacheSize>100</CacheSize>
  </Performance>
  
  <Network>
    <ProxyServer></ProxyServer>
    <ProxyPort>8080</ProxyPort>
    <ProxyUser></ProxyUser>
    <Timeout>30000</Timeout>
    <RetryCount>3</RetryCount>
  </Network>
  
  <Security>
    <EnableEncryption>true</EnableEncryption>
    <CertificatePath></CertificatePath>
    <AllowedDomains>
      <Domain>*.zwdynlookup.com</Domain>
      <Domain>*.zwcad.com</Domain>
    </AllowedDomains>
  </Security>
  
  <Logging>
    <LogFile>%USERPROFILE%\Documents\ZWDynLookup\Plugin.log</LogFile>
    <LogMaxSize>10MB</LogMaxSize>
    <LogBackupCount>5</LogBackupCount>
    <EnableConsoleLog>false</EnableConsoleLog>
    <EnableFileLog>true</EnableFileLog>
  </Logging>
</Configuration>
```

### 企业配置管理

#### 集中配置服务器
```csharp
// 配置管理服务 - ConfigurationService.cs
public class ConfigurationService
{
    private readonly string _configServerUrl;
    private readonly HttpClient _httpClient;
    
    public ConfigurationService(string configServerUrl)
    {
        _configServerUrl = configServerUrl;
        _httpClient = new HttpClient();
        _httpClient.Timeout = TimeSpan.FromSeconds(30);
    }
    
    // 下载配置
    public async Task<Configuration> DownloadConfigurationAsync(string userId, string computerId)
    {
        var request = new ConfigurationRequest
        {
            UserId = userId,
            ComputerId = computerId,
            Version = "1.0.0"
        };
        
        var response = await _httpClient.PostAsJsonAsync($"{_configServerUrl}/api/config/download", request);
        response.EnsureSuccessStatusCode();
        
        return await response.Content.ReadFromJsonAsync<Configuration>();
    }
    
    // 上传配置
    public async Task UploadConfigurationAsync(string userId, Configuration config)
    {
        var uploadRequest = new ConfigurationUploadRequest
        {
            UserId = userId,
            Configuration = config,
            Timestamp = DateTime.UtcNow
        };
        
        await _httpClient.PostAsJsonAsync($"{_configServerUrl}/api/config/upload", uploadRequest);
    }
    
    // 同步配置
    public async Task<bool> SyncConfigurationAsync(string userId, string computerId)
    {
        try
        {
            var localConfig = LoadLocalConfiguration();
            var serverConfig = await DownloadConfigurationAsync(userId, computerId);
            
            if (serverConfig.Version > localConfig.Version)
            {
                SaveConfiguration(serverConfig);
                return true;
            }
            
            return false;
        }
        catch (Exception ex)
        {
            // 记录错误
            PluginEntry.Log($"配置同步失败: {ex.Message}");
            return false;
        }
    }
}
```

#### 配置策略
```xml
<!-- 企业配置策略 - EnterprisePolicy.xml -->
<Policy>
  <Deployment>
    <InstallType>Network</InstallType>
    <UpdateMode>Automatic</UpdateMode>
    <ForceUpdate>false</ForceUpdate>
    <UpdateCheckInterval>24</UpdateCheckInterval>
  </Deployment>
  
  <Security>
    <RequireDigitalSignature>true</RequireDigitalSignature>
    <AllowUserModifications>false</AllowUserModifications>
    <EncryptConfiguration>true</EncryptConfiguration>
    <CertificateValidation>Required</CertificateValidation>
  </Security>
  
  <Permissions>
    <AllowParameterCreation>true</AllowParameterCreation>
    <AllowActionCreation>true</AllowActionCreation>
    <AllowLookupTableEdit>true</AllowLookupTableEdit>
    <AllowBatchOperations>true</AllowBatchOperations>
    <MaxParametersPerBlock>30</MaxParametersPerBlock>
  </Permissions>
  
  <Monitoring>
    <EnableUsageTracking>true</EnableUsageTracking>
    <EnableErrorReporting>true</EnableErrorReporting>
    <EnablePerformanceMonitoring>true</EnablePerformanceMonitoring>
    <ReportInterval>7</ReportInterval>
  </Monitoring>
  
  <Backup>
    <AutoBackup>true</AutoBackup>
    <BackupInterval>24</BackupInterval>
    <KeepBackups>30</KeepBackups>
    <BackupLocation>\\Server\Backups\ZWDynLookup</BackupLocation>
  </Backup>
</Policy>
```

---

## 企业级部署

### Active Directory 集成

#### 组策略部署
```xml
<!-- 组策略模板 - ZWDynLookup.admx -->
<?xml version="1.0" encoding="utf-8"?>
<policyDefinitions xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" revision="1.0" schemaVersion="1.0" xmlns="http://schemas.microsoft.com/GroupPolicy/2006/07/PolicyDefinitions">
  <policyDefinition name="ZWDynLookup_InstallPath" class="Machine" key="SOFTWARE\Policies\ZWDynLookup" valueName="InstallPath">
    <parentCategory ref="ZWDynLookup" />
    <supportedOn ref="windows:SUPPORTED_WindowsVista" />
    <enabledValue>
      <decimal value="1" />
    </enabledValue>
    <disabledValue>
      <decimal value="0" />
    </disabledValue>
    <string>
      <defaultValue>C:\Program Files\ZWDynLookup</defaultValue>
      <valueName>InstallPath</valueName>
    </string>
  </policyDefinition>
  
  <policyDefinition name="ZWDynLookup_UpdateMode" class="Machine" key="SOFTWARE\Policies\ZWDynLookup" valueName="UpdateMode">
    <parentCategory ref="ZWDynLookup" />
    <supportedOn ref="windows:SUPPORTED_WindowsVista" />
    <enabledValue>
      <string>
        <value>
          <enabledValue>
            <decimal value="1" />
          </enabledValue>
        </value>
      </string>
    </enabledValue>
    <disabledValue>
      <string>
        <value>
          <disabledValue>
            <decimal value="0" />
          </disabledValue>
        </value>
      </string>
    </disabledValue>
    <string>
      <defaultValue>Automatic</defaultValue>
      <valueName>UpdateMode</valueName>
    </string>
  </policyDefinition>
</policyDefinitions>
```

#### PowerShell DSC 配置
```powershell
# ZWDynLookupDSC.ps1
Configuration ZWDynLookupConfig {
    param(
        [string[]]$ComputerName = @('localhost')
    )
    
    Node $ComputerName {
        # 安装.NET Framework 4.8
        WindowsFeature NetFramework48 {
            Name = 'Net-Framework-48-Core'
            Ensure = 'Present'
        }
        
        # 安装中望CAD依赖
        Package ZwCADPrerequisites {
            Name = 'ZwCAD Prerequisites'
            Path = '\\Server\Install\ZwCAD\Prerequisites.exe'
            Arguments = '/S /V/qn'
            ProductId = '12345678-1234-1234-1234-123456789012'
            DependsOn = '[WindowsFeature]NetFramework48'
        }
        
        # 复制插件文件
        File PluginFiles {
            DestinationPath = 'C:\Program Files\ZWDynLookup'
            SourcePath = '\\Server\Install\ZWDynLookup'
            Recurse = $true
            Ensure = 'Present'
            DependsOn = '[Package]ZwCADPrerequisites'
        }
        
        # 注册插件
        Registry PluginRegistration {
            Key = 'HKLM:\SOFTWARE\WOW6432Node\ZWDynLookup'
            ValueName = 'InstallPath'
            ValueData = 'C:\Program Files\ZWDynLookup'
            Ensure = 'Present'
            DependsOn = '[File]PluginFiles'
        }
        
        # 配置Windows服务
        Service PluginService {
            Name = 'ZWDynLookupService'
            State = 'Running'
            StartupType = 'Automatic'
            DependsOn = '[Registry]PluginRegistration'
        }
    }
}

# 生成和推送配置
ZWDynLookupConfig -ComputerName @('PC001', 'PC002', 'PC003')
Start-DscConfiguration -Path .\ZWDynLookupConfig -Wait -Verbose
```

### 容器化部署

#### Docker 配置
```dockerfile
# Dockerfile
FROM mcr.microsoft.com/windows/servercore:ltsc2019

# 设置工作目录
WORKDIR C:/ZWDynLookup

# 复制安装文件
COPY . .

# 安装插件
RUN Start-Process -FilePath "ZWDynLookup_Setup.exe" -ArgumentList "/S /V/qn" -Wait

# 配置环境变量
ENV ZWDYNLOOKUP_HOME=C:\\Program Files\\ZWDynLookup
ENV ZWDYNLOOKUP_CONFIG=C:\\Users\\ContainerUser\\Documents\\ZWDynLookup

# 暴露端口（如果需要Web管理界面）
EXPOSE 8080

# 启动命令
CMD ["powershell", "-Command", "Start-Process", "ZwCAD.exe", "-ArgumentList", "/LoadPlugin", "C:\\Program Files\\ZWDynLookup\\ZWDynLookup.dll"]
```

#### Docker Compose 配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  zwdynlookup-server:
    build: .
    ports:
      - "8080:8080"
    environment:
      - ZWDYNLOOKUP_MODE=Server
      - ZWDYNLOOKUP_CONFIG_SERVER=http://config-server:8080
    volumes:
      - config_data:/app/config
      - logs_data:/app/logs
    depends_on:
      - config-server
      - update-server
  
  config-server:
    image: nginx:alpine
    ports:
      - "8081:80"
    volumes:
      - ./config-server:/usr/share/nginx/html
    environment:
      - NGINX_PORT=80
  
  update-server:
    image: nginx:alpine
    ports:
      - "8082:80"
    volumes:
      - ./update-server:/usr/share/nginx/html

volumes:
  config_data:
  logs_data:
```

---

## 卸载回滚

### 标准卸载

#### 静默卸载
```batch
:: 静默卸载脚本 - SilentUninstall.bat
@echo off
echo 正在卸载中望CAD动态块查寻插件...

:: 检查管理员权限
net session >nul 2>&1
if %errorlevel% neq 0 (
    echo 错误: 需要管理员权限运行此脚本
    pause
    exit /b 1
)

:: 执行卸载
msiexec /x {12345678-1234-1234-1234-123456789012} /qn /norestart

:: 清理残留文件
if exist "C:\Program Files\ZWDynLookup" (
    rmdir /s /q "C:\Program Files\ZWDynLookup"
)

:: 清理注册表项
reg delete "HKLM\SOFTWARE\WOW6432Node\ZWDynLookup" /f

:: 清理配置文件
if exist "%USERPROFILE%\Documents\ZWDynLookup" (
    rmdir /s /q "%USERPROFILE%\Documents\ZWDynLookup"
)

:: 清理日志文件
if exist "%USERPROFILE%\Documents\ZWDynLookup\Plugin.log" (
    del "%USERPROFILE%\Documents\ZWDynLookup\Plugin.log"
)

echo 插件卸载完成
pause
```

#### PowerShell 卸载脚本
```powershell
# Uninstall.ps1
param(
    [switch]$Force = $false,
    [switch]$KeepConfig = $false
)

Write-Host "正在卸载中望CAD动态块查寻插件..." -ForegroundColor Yellow

# 检查管理员权限
if (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator"))
{
    Write-Error "需要管理员权限运行此脚本"
    exit 1
}

try {
    # 停止相关进程
    $processes = Get-Process | Where-Object { $_.ProcessName -like "*ZWDynLookup*" -or $_.ProcessName -like "*ZwCAD*" }
    if ($processes) {
        Write-Host "正在停止相关进程..." -ForegroundColor Yellow
        $processes | Stop-Process -Force
    }
    
    # 卸载MSI包
    $msiProducts = Get-WmiObject -Query "SELECT * FROM Win32_Product WHERE Name LIKE '%ZWDynLookup%'"
    foreach ($product in $msiProducts) {
        Write-Host "正在卸载产品: $($product.Name)" -ForegroundColor Yellow
        $product.Uninstall()
    }
    
    # 清理安装目录
    $installPath = "C:\Program Files\ZWDynLookup"
    if (Test-Path $installPath) {
        Write-Host "正在清理安装目录..." -ForegroundColor Yellow
        Remove-Item -Path $installPath -Recurse -Force
    }
    
    # 清理注册表
    $regPaths = @(
        "HKLM:\SOFTWARE\WOW6432Node\ZWDynLookup",
        "HKLM:\SOFTWARE\ZWDynLookup",
        "HKCU:\SOFTWARE\ZWDynLookup"
    )
    
    foreach ($regPath in $regPaths) {
        if (Test-Path $regPath) {
            Write-Host "正在清理注册表项: $regPath" -ForegroundColor Yellow
            Remove-Item -Path $regPath -Recurse -Force
        }
    }
    
    # 清理配置文件（可选）
    $configPath = "$env:USERPROFILE\Documents\ZWDynLookup"
    if (Test-Path $configPath) {
        if ($KeepConfig) {
            Write-Host "保留配置文件: $configPath" -ForegroundColor Green
        }
        else {
            Write-Host "正在清理配置文件..." -ForegroundColor Yellow
            Remove-Item -Path $configPath -Recurse -Force
        }
    }
    
    Write-Host "插件卸载完成！" -ForegroundColor Green
    
    if (-not $KeepConfig) {
        Write-Host "建议重启计算机以完全清理环境" -ForegroundColor Cyan
    }
}
catch {
    Write-Error "卸载过程中发生错误: $($_.Exception.Message)"
    exit 1
}
```

### 回滚机制

#### 自动回滚脚本
```powershell
# Rollback.ps1
param(
    [Parameter(Mandatory=$true)]
    [string]$BackupPath
)

Write-Host "开始回滚到备份版本..." -ForegroundColor Yellow

# 检查备份文件
if (-not (Test-Path $backupPath)) {
    Write-Error "备份文件不存在: $backupPath"
    exit 1
}

try {
    # 当前版本备份
    $currentBackup = "$env:TEMP\ZWDynLookup_Current_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
    Write-Host "正在备份当前版本..." -ForegroundColor Yellow
    
    if (Test-Path "C:\Program Files\ZWDynLookup") {
        Copy-Item -Path "C:\Program Files\ZWDynLookup" -Destination $currentBackup -Recurse
    }
    
    # 停止插件服务
    $services = Get-Service | Where-Object { $_.Name -like "*ZWDynLookup*" }
    foreach ($service in $services) {
        Write-Host "正在停止服务: $($service.Name)" -ForegroundColor Yellow
        Stop-Service -Name $service.Name -Force
    }
    
    # 卸载当前版本
    Write-Host "正在卸载当前版本..." -ForegroundColor Yellow
    & ".\Uninstall.ps1" -KeepConfig
    
    # 恢复备份版本
    Write-Host "正在恢复备份版本..." -ForegroundColor Yellow
    Copy-Item -Path $backupPath -Destination "C:\Program Files\ZWDynLookup" -Recurse
    
    # 恢复注册表
    if (Test-Path "$backupPath\registry_backup.reg") {
        Write-Host "正在恢复注册表..." -ForegroundColor Yellow
        & "regedit.exe" /s "$backupPath\registry_backup.reg"
    }
    
    # 重新注册插件
    Write-Host "正在重新注册插件..." -ForegroundColor Yellow
    $regsvr32 = Join-Path $backupPath "ZWDynLookup.dll"
    if (Test-Path $regsvr32) {
        & "regsvr32.exe" /s $regsvr32
    }
    
    Write-Host "回滚完成！" -ForegroundColor Green
    Write-Host "原版本已备份到: $currentBackup" -ForegroundColor Cyan
}
catch {
    Write-Error "回滚过程中发生错误: $($_.Exception.Message)"
    Write-Host "如果回滚失败，请手动恢复或重新安装" -ForegroundColor Red
    exit 1
}
```

---

## 监控维护

### 部署监控

#### 健康检查脚本
```powershell
# HealthCheck.ps1
param(
    [string]$ComputerName = "localhost"
)

function Test-PluginInstallation {
    $regPath = "HKLM:\SOFTWARE\WOW6432Node\ZWDynLookup"
    if (Test-Path $regPath) {
        $installPath = Get-ItemProperty $regPath -Name "InstallPath" -ErrorAction SilentlyContinue
        if ($installPath -and (Test-Path $installPath.InstallPath)) {
            return @{ Status = "Healthy"; Path = $installPath.InstallPath }
        }
    }
    return @{ Status = "Unhealthy"; Error = "插件未安装或安装路径无效" }
}

function Test-PluginService {
    $service = Get-Service -Name "ZWDynLookupService" -ErrorAction SilentlyContinue
    if ($service) {
        return @{ Status = $service.Status; ServiceName = $service.Name }
    }
    return @{ Status = "NotFound"; Error = "插件服务未找到" }
}

function Test-PluginConfiguration {
    $configPath = "$env:USERPROFILE\Documents\ZWDynLookup\config.xml"
    if (Test-Path $configPath) {
        try {
            [xml]$config = Get-Content $configPath
            return @{ Status = "Healthy"; ConfigFile = $configPath }
        }
        catch {
            return @{ Status = "Error"; Error = "配置文件格式错误" }
        }
    }
    return @{ Status = "Warning"; Error = "配置文件未找到" }
}

function Test-PluginLog {
    $logPath = "$env:USERPROFILE\Documents\ZWDynLookup\Plugin.log"
    if (Test-Path $logPath) {
        $logSize = (Get-Item $logPath).Length
        $lastModified = (Get-Item $logPath).LastWriteTime
        return @{ Status = "Healthy"; LogSize = $logSize; LastModified = $lastModified }
    }
    return @{ Status = "Warning"; Error = "日志文件未找到" }
}

# 执行健康检查
Write-Host "正在检查 $ComputerName 的插件状态..." -ForegroundColor Cyan

$installation = Test-PluginInstallation
$service = Test-PluginService
$configuration = Test-PluginConfiguration
$log = Test-PluginLog

# 生成健康报告
$healthReport = @{
    ComputerName = $ComputerName
    CheckTime = Get-Date
    Installation = $installation
    Service = $service
    Configuration = $configuration
    Log = $log
}

# 输出结果
Write-Host "`n健康检查报告:" -ForegroundColor Green
Write-Host "==================" -ForegroundColor Green
Write-Host "计算机: $($healthReport.ComputerName)" -ForegroundColor White
Write-Host "检查时间: $($healthReport.CheckTime)" -ForegroundColor White
Write-Host ""
Write-Host "插件安装: $($installation.Status)" -ForegroundColor $(if($installation.Status -eq "Healthy") { "Green" } else { "Red" })
if ($installation.Error) { Write-Host "  错误: $($installation.Error)" -ForegroundColor Red }
Write-Host ""
Write-Host "插件服务: $($service.Status)" -ForegroundColor $(if($service.Status -eq "Running") { "Green" } else { "Yellow" })
if ($service.Error) { Write-Host "  错误: $($service.Error)" -ForegroundColor Red }
Write-Host ""
Write-Host "插件配置: $($configuration.Status)" -ForegroundColor $(if($configuration.Status -eq "Healthy") { "Green" } else { "Yellow" })
if ($configuration.Error) { Write-Host "  错误: $($configuration.Error)" -ForegroundColor Red }
Write-Host ""
Write-Host "插件日志: $($log.Status)" -ForegroundColor $(if($log.Status -eq "Healthy") { "Green" } else { "Yellow" })
if ($log.Error) { Write-Host "  错误: $($log.Error)" -ForegroundColor Red }

# 保存报告
$reportPath = "$env:TEMP\ZWDynLookup_HealthReport_$(Get-Date -Format 'yyyyMMdd_HHmmss').json"
$healthReport | ConvertTo-Json | Out-File $reportPath
Write-Host "`n详细报告已保存到: $reportPath" -ForegroundColor Cyan

return $healthReport
```

#### 批量监控脚本
```powershell
# BatchHealthCheck.ps1
param(
    [string[]]$ComputerList,
    [string]$OutputPath = ".\HealthReports"
)

# 创建输出目录
if (!(Test-Path $OutputPath)) {
    New-Item -ItemType Directory -Path $OutputPath -Force
}

$healthResults = @()
$failedComputers = @()

foreach ($computer in $ComputerList) {
    Write-Host "正在检查 $computer..." -ForegroundColor Yellow
    
    try {
        $healthResult = Invoke-Command -ComputerName $computer -ScriptBlock {
            & "C:\Scripts\HealthCheck.ps1"
        } -ErrorAction Stop
        
        $healthResult | Add-Member -NotePropertyName "ComputerName" -NotePropertyValue $computer -Force
        $healthResults += $healthResult
        
        Write-Host "✓ $computer 检查完成" -ForegroundColor Green
    }
    catch {
        Write-Host "✗ $computer 检查失败: $($_.Exception.Message)" -ForegroundColor Red
        $failedComputers += $computer
    }
}

# 生成汇总报告
$summary = @{
    TotalComputers = $ComputerList.Count
    SuccessfulChecks = $healthResults.Count
    FailedChecks = $failedComputers.Count
    CheckTime = Get-Date
    Results = $healthResults
    FailedComputers = $failedComputers
}

# 保存汇总报告
$summaryPath = Join-Path $OutputPath "HealthSummary_$(Get-Date -Format 'yyyyMMdd_HHmmss').json"
$summary | ConvertTo-Json -Depth 3 | Out-File $summaryPath

# 生成HTML报告
$htmlReport = @"
<!DOCTYPE html>
<html>
<head>
    <title>ZWDynLookup 健康检查报告</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background-color: #f0f0f0; padding: 10px; border-radius: 5px; }
        .summary { margin: 20px 0; }
        .healthy { color: green; }
        .warning { color: orange; }
        .error { color: red; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="header">
        <h1>中望CAD动态块查寻插件健康检查报告</h1>
        <p>检查时间: $(Get-Date)</p>
        <p>总计计算机: $($summary.TotalComputers)</p>
        <p>成功检查: $($summary.SuccessfulChecks)</p>
        <p>失败检查: $($summary.FailedChecks)</p>
    </div>
    
    <div class="summary">
        <h2>详细结果</h2>
        <table>
            <tr>
                <th>计算机名</th>
                <th>安装状态</th>
                <th>服务状态</th>
                <th>配置状态</th>
                <th>日志状态</th>
            </tr>
"@

foreach ($result in $healthResults) {
    $installClass = if ($result.Installation.Status -eq "Healthy") { "healthy" } elseif ($result.Installation.Status -eq "Warning") { "warning" } else { "error" }
    $serviceClass = if ($result.Service.Status -eq "Running") { "healthy" } elseif ($result.Service.Status -eq "Stopped") { "warning" } else { "error" }
    $configClass = if ($result.Configuration.Status -eq "Healthy") { "healthy" } elseif ($result.Configuration.Status -eq "Warning") { "warning" } else { "error" }
    $logClass = if ($result.Log.Status -eq "Healthy") { "healthy" } elseif ($result.Log.Status -eq "Warning") { "warning" } else { "error" }
    
    $htmlReport += @"
            <tr>
                <td>$($result.ComputerName)</td>
                <td class="$installClass">$($result.Installation.Status)</td>
                <td class="$serviceClass">$($result.Service.Status)</td>
                <td class="$configClass">$($result.Configuration.Status)</td>
                <td class="$logClass">$($result.Log.Status)</td>
            </tr>
"@
}

$htmlReport += @"
        </table>
    </div>
</body>
</html>
"@

$htmlPath = Join-Path $OutputPath "HealthReport_$(Get-Date -Format 'yyyyMMdd_HHmmss').html"
$htmlReport | Out-File $htmlPath -Encoding UTF8

Write-Host "`n监控完成！" -ForegroundColor Green
Write-Host "汇总报告: $summaryPath" -ForegroundColor Cyan
Write-Host "HTML报告: $htmlPath" -ForegroundColor Cyan

if ($failedComputers.Count -gt 0) {
    Write-Host "`n失败的计算机:" -ForegroundColor Red
    $failedComputers | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
}
```

### 维护任务

#### 自动维护脚本
```powershell
# Maintenance.ps1
param(
    [string]$Action = "full"
)

$logPath = "$env:USERPROFILE\Documents\ZWDynLookup\Maintenance.log"
$configPath = "$env:USERPROFILE\Documents\ZWDynLookup"

function Write-MaintenanceLog {
    param([string]$Message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] $Message"
    Write-Host $logMessage
    Add-Content -Path $logPath -Value $logMessage
}

switch ($Action.ToLower()) {
    "cleanup" {
        Write-MaintenanceLog "开始清理任务..."
        
        # 清理临时文件
        $tempFiles = Get-ChildItem "$configPath\Temp" -Recurse -ErrorAction SilentlyContinue
        $tempFiles | Remove-Item -Force -ErrorAction SilentlyContinue
        Write-MaintenanceLog "清理临时文件: $($tempFiles.Count) 个"
        
        # 清理旧日志
        $logFiles = Get-ChildItem "$configPath\Logs" -Filter "*.log" | Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-30) }
        $logFiles | Remove-Item -Force -ErrorAction SilentlyContinue
        Write-MaintenanceLog "清理旧日志文件: $($logFiles.Count) 个"
        
        # 清理备份
        $backupFiles = Get-ChildItem "$configPath\Backups" -Recurse | Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-7) }
        $backupFiles | Remove-Item -Force -ErrorAction SilentlyContinue
        Write-MaintenanceLog "清理旧备份: $($backupFiles.Count) 个"
    }
    
    "backup" {
        Write-MaintenanceLog "开始备份任务..."
        
        $backupDir = "$configPath\Backups\AutoBackup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
        New-Item -ItemType Directory -Path $backupDir -Force
        
        # 备份配置文件
        Copy-Item "$configPath\config.xml" $backupDir
        
        # 备份用户数据
        if (Test-Path "$configPath\UserData") {
            Copy-Item "$configPath\UserData" "$backupDir\UserData" -Recurse
        }
        
        Write-MaintenanceLog "备份完成: $backupDir"
    }
    
    "update" {
        Write-MaintenanceLog "开始更新检查..."
        
        $currentVersion = Get-ItemProperty "HKLM:\SOFTWARE\WOW6432Node\ZWDynLookup" -Name "Version" -ErrorAction SilentlyContinue
        $updateServer = "https://updates.zwdynlookup.com"
        
        try {
            $latestVersion = Invoke-RestMethod "$updateServer/api/latest-version" -TimeoutSec 30
            if ($latestVersion.Version -gt $currentVersion.Version) {
                Write-MaintenanceLog "发现新版本: $($latestVersion.Version)"
                # 这里可以添加自动更新逻辑
            }
            else {
                Write-MaintenanceLog "当前版本已是最新"
            }
        }
        catch {
            Write-MaintenanceLog "更新检查失败: $($_.Exception.Message)"
        }
    }
    
    "full" {
        Write-MaintenanceLog "开始完整维护任务..."
        
        & $PSCommandPath -Action "cleanup"
        & $PSCommandPath -Action "backup"
        & $PSCommandPath -Action "update"
        
        Write-MaintenanceLog "完整维护任务完成"
    }
    
    default {
        Write-Error "未知的维护操作: $Action"
        exit 1
    }
}
```

### 性能监控

#### 性能计数器
```csharp
// PerformanceMonitor.cs
public class PerformanceMonitor
{
    private readonly PerformanceCounter _cpuCounter;
    private readonly PerformanceCounter _memoryCounter;
    private readonly PerformanceCounter _diskCounter;
    
    public PerformanceMonitor()
    {
        _cpuCounter = new PerformanceCounter("Processor", "% Processor Time", "_Total");
        _memoryCounter = new PerformanceCounter("Memory", "Available MBytes");
        _diskCounter = new PerformanceCounter("LogicalDisk", "% Disk Time", "_Total");
    }
    
    public PluginPerformanceData GetPerformanceData()
    {
        return new PluginPerformanceData
        {
            Timestamp = DateTime.Now,
            CpuUsage = GetCpuUsage(),
            MemoryUsage = GetMemoryUsage(),
            DiskUsage = GetDiskUsage(),
            PluginSpecificMetrics = GetPluginMetrics()
        };
    }
    
    private double GetCpuUsage()
    {
        return _cpuCounter.NextValue();
    }
    
    private long GetMemoryUsage()
    {
        return (long)_memoryCounter.NextValue();
    }
    
    private double GetDiskUsage()
    {
        return _diskCounter.NextValue();
    }
    
    private PluginMetrics GetPluginMetrics()
    {
        return new PluginMetrics
        {
            LoadedBlocks = GetLoadedBlocksCount(),
            ActiveParameters = GetActiveParametersCount(),
            MemoryUsage = GC.GetTotalMemory(false),
            ThreadCount = Process.GetCurrentProcess().Threads.Count
        };
    }
}

public class PluginPerformanceData
{
    public DateTime Timestamp { get; set; }
    public double CpuUsage { get; set; }
    public long MemoryUsage { get; set; }
    public double DiskUsage { get; set; }
    public PluginMetrics PluginSpecificMetrics { get; set; }
}
```

---

**文档版本：** 1.0  
**最后更新：** 2024年12月  
**维护者：** 中望CAD动态块查寻插件开发团队